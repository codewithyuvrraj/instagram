<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GENZES CHATS</title>
  <link rel="icon" type="image/x-icon" href="l2.png">
  <link rel="shortcut icon" type="image/x-icon" href="l2.png">

  <style>
    :root {
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --border: rgba(255, 255, 255, 0.1);
      --bg-dark: #1a1a1a;
      --bg-darker: #0f0f0f;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: #ffffff;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    .site-header {
      background: var(--bg-darker);
      border-bottom: 1px solid var(--border);
      padding: 1rem 0;
    }
    
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .hidden {
      display: none !important;
    }
    
    .app-container {
      min-height: 100vh;
      background: var(--bg-dark);
    }
    
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--bg-darker);
      border-bottom: 1px solid var(--border);
    }
    
    .header-actions {
      display: flex;
      gap: 1rem;
    }
    
    .icon-btn {
      background: none;
      border: none;
      color: #ffffff;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .main-content {
      position: relative;
    }
    
    .content-section {
      display: none;
      height: calc(100vh - 140px);
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: 20px;
    }
    
    .content-section.active {
      display: block;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-darker);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      z-index: 1000;
    }
    
    #chatArea {
      z-index: 10;
      pointer-events: auto;
    }
    
    .content-section {
      z-index: 20;
      position: relative;
    }
    
    .modal {
      z-index: 2000;
    }
    
    .nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      background: none;
      border: none;
      color: #8e8e8e;
      cursor: pointer;
      padding: 0.5rem;
      transition: all 0.2s;
    }
    
    .nav-btn.active {
      color: #ffffff;
    }
    
    .nav-label {
      font-size: 0.75rem;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
    }
    
    .modal-dialog {
      background: var(--bg-darker);
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      z-index: 1001;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #ffffff;
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .modal-form {
      padding: 1rem;
    }
    
    .modal-form label {
      display: block;
      margin-bottom: 1rem;
      color: #ffffff;
    }
    
    .modal-form input,
    .modal-form textarea,
    .modal-form select {
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: #ffffff;
    }
    
    .upload-btn {
      background: #0095f6;
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1rem;
    }
    
    .cancel-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .save-btn {
      background: #0095f6;
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes settingsSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes typingDots {
      0%, 60%, 100% { opacity: 0.3; }
      30% { opacity: 1; }
    }
    
    .typing-dots span {
      animation: typingDots 1.4s infinite;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    .settings-btn svg {
      animation: settingsSpin 4s linear infinite;
      transition: animation-duration 0.3s ease;
    }
    
    .settings-btn:hover svg {
      animation-duration: 0.5s;
    }
    
    .create-options {
      padding: 2rem;
    }
    
    .create-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .create-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 2rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .create-option:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .create-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .create-option:hover .create-icon {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .create-option span {
      font-size: 1rem;
      font-weight: 600;
      color: #ffffff;
    }
    .post-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
    }
    
    .post-actions-left {
      display: flex;
      gap: 16px;
    }
    
    .post-action {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .post-action:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }
    
    .post-action svg {
      transition: all 0.2s ease;
    }
    
    .like-btn.liked svg {
      fill: #ff3040 !important;
      stroke: #ff3040 !important;
      animation: likeAnimation 0.3s ease;
    }
    
    .save-btn.saved svg {
      fill: #ffd700 !important;
      stroke: #ffd700 !important;
    }
    
    @keyframes likeAnimation {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    
    .post-stats {
      padding: 0 16px 8px;
    }
    
    .post-likes {
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
    }
    
    .post-likes:hover {
      text-decoration: underline;
    }
    
    .share-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      padding: 16px;
    }
    
    .share-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    /* Performance optimizations */
    .skeleton {
      height: 200px;
      background: linear-gradient(90deg, #333 25%, #444 37%, #333 63%);
      background-size: 400% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 8px;
    }
    
    @keyframes shimmer {
      0% { background-position: -400px 0; }
      100% { background-position: 400px 0; }
    }
    
    .lazy-img {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .lazy-img.loaded {
      opacity: 1;
    }
    
    /* Optimize images for faster loading */
    img {
      max-width: 100%;
      height: auto;
    }
    
    .post-image, .story-image {
      width: 100%;
      border-radius: 12px;
      object-fit: cover;
    }
    }
    
    .share-option:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .share-icon {
      font-size: 24px;
    }
    
    /* Message username styles */
    .message-sender {
      font-size: 0.75rem;
      color: #8e8e8e;
      margin-bottom: 4px;
      margin-left: 12px;
      font-weight: 500;
    }
    
    .message-wrapper.me .message-sender {
      display: none;
    }
    
    .message-wrapper.them .message-sender {
      text-align: left;
    }
    
    .message-wrapper {
      margin-bottom: 8px;
    }
    
    .message-wrapper.me {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .message-wrapper.them {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    
    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 18px;
      position: relative;
    }
    
    .message-wrapper.me .message {
      background: #0095f6;
      color: white;
    }
    
    .message-wrapper.them .message {
      background: #f0f0f0;
      color: #000;
    }
    
    .message-time {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 4px;
    }
    
    .date-separator {
      text-align: center;
      color: #8e8e8e;
      font-size: 0.75rem;
      margin: 16px 0;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: inline-block;
      margin-left: 50%;
      transform: translateX(-50%);
    }
    
    .comments-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
    }
    
    .feed-container {
      max-width: 600px;
      margin: 0 auto;
      height: 100%;
    }
    
    #feed {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      padding-bottom: 2rem;
    }
    
    .reels-feed-container {
      height: 100%;
      overflow: hidden;
    }y: auto;
      margin-bottom: 16px;
    }
    
    .comment-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .comment-text {
      color: #ffffff;
      margin-bottom: 4px;
    }
    
    .comment-time {
      color: #8e8e8e;
      font-size: 12px;
    }
    
    .comment-form {
      display: flex;
      gap: 8px;
    }
    
    .comment-form input {
      flex: 1;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      color: #ffffff;
    }
    
    .comment-form button {
      padding: 8px 16px;
      background: #0095f6;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }

    /* Post Menu Styles */
    .post-more-container {
      position: relative;
      margin-left: auto;
    }

    .post-more {
      background: none;
      border: none;
      color: #ffffff;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .post-more:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    .post-more svg {
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .post-more:hover svg {
      opacity: 1;
    }

    .post-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(20, 20, 30, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      min-width: 180px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(15px);
      z-index: 1000;
      display: none;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .post-menu.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .post-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 14px 18px;
      background: none;
      border: none;
      color: #ffffff;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .post-menu-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .post-menu-item:hover::before {
      left: 100%;
    }

    .post-menu-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(2px);
    }

    .post-menu-item:nth-child(1):hover {
      background: linear-gradient(135deg, rgba(64, 93, 230, 0.2), rgba(88, 81, 219, 0.2));
      color: #5d8bff;
    }

    .post-menu-item:nth-child(2):hover {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.2));
      color: #4ade80;
    }

    .post-menu-item:nth-child(3):hover {
      background: linear-gradient(135deg, rgba(245, 133, 41, 0.2), rgba(221, 42, 123, 0.2));
      color: #fb923c;
    }

    .post-menu-item svg {
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .post-menu-item:hover svg {
      opacity: 1;
    }

    /* Reel Menu Styles */
    .reel-more-container {
      position: relative;
    }

    .reel-more {
      background: none;
      border: none;
      color: #ffffff;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reel-more:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    .reel-more svg {
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .reel-more:hover svg {
      opacity: 1;
    }

    .reel-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(20, 20, 30, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      min-width: 180px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(15px);
      z-index: 1000;
      display: none;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .reel-menu.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .reel-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 14px 18px;
      background: none;
      border: none;
      color: #ffffff;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .reel-menu-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }

    .reel-menu-item:hover::before {
      left: 100%;
    }

    .reel-menu-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(2px);
    }

    .reel-menu-item:nth-child(1):hover {
      background: linear-gradient(135deg, rgba(64, 93, 230, 0.2), rgba(88, 81, 219, 0.2));
      color: #5d8bff;
    }

    .reel-menu-item:nth-child(2):hover {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.2));
      color: #4ade80;
    }

    .reel-menu-item:nth-child(3):hover {
      background: linear-gradient(135deg, rgba(245, 133, 41, 0.2), rgba(221, 42, 123, 0.2));
      color: #fb923c;
    }

    .reel-menu-item svg {
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .reel-menu-item:hover svg {
      opacity: 1;
    }

    /* Reel Layout Improvements */
    .reel-item {
      position: relative;
      margin-bottom: 2rem;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
    }

    .reel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .reel-user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .reel-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background: #e1306c;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .reel-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .reel-username {
      color: #ffffff;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .reel-video-container {
      position: relative;
      width: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reel-video-container video,
    .reel-video-container img {
      width: 100%;
      height: auto;
      max-height: 600px;
      object-fit: contain;
      display: block;
    }

    .reel-sidebar {
      position: absolute;
      right: 1rem;
      bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .reel-action {
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: #ffffff;
      cursor: pointer;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .reel-action:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .reel-action span {
      font-size: 0.7rem;
      font-weight: 600;
    }

    .reel-info {
      padding: 1rem;
      color: #ffffff;
    }

    .reel-caption {
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .reel-music {
      color: #8e8e8e;
      font-size: 0.9rem;
    }
    
    /* Enhanced Chat Styles */
    .whatsapp-chat {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
    }
    
    .search-hint {
      text-align: center;
      padding: 2rem;
      color: #8e8e8e;
      font-style: italic;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin: 1rem;
    }
    
    .message-wrapper {
      display: flex;
      width: 100%;
    }
    
    .message-wrapper.me {
      justify-content: flex-end;
    }
    
    .message-wrapper.them {
      justify-content: flex-start;
    }
    
    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 20px;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      position: relative;
      margin: 4px 0;
    }
    
    .message-wrapper.me .message {
      background: linear-gradient(135deg, #0084ff 0%, #0066cc 100%);
      color: white;
      border-bottom-right-radius: 6px;
      margin-left: auto;
    }
    
    .message-wrapper.them .message {
      background: #ffffff;
      color: #000;
      border-bottom-left-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .message.first {
      margin-top: 8px;
    }
    
    .message.last {
      margin-bottom: 8px;
    }
    
    .message-content {
      display: flex;
      flex-direction: column;
    }
    
    .message-text {
      margin-bottom: 4px;
    }
    
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      align-self: flex-end;
      margin-top: 4px;
      color: inherit;
    }
    
    .message-wrapper.me .message-time {
      color: rgba(255, 255, 255, 0.8);
    }
    
    .message-wrapper.them .message-time {
      color: rgba(0, 0, 0, 0.6);
    }
    
    .date-separator {
      text-align: center;
      margin: 20px 0;
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
      background: rgba(0, 0, 0, 0.2);
      padding: 6px 12px;
      border-radius: 12px;
      display: inline-block;
      align-self: center;
      backdrop-filter: blur(10px);
    }
    
    /* Chat Styles */
    .messages-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .messages-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .chat-search-container {
      margin-bottom: 1rem;
    }
    
    .chat-search-box {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .chat-search-box input {
      width: 100%;
      padding: 0.75rem 0.75rem 0.75rem 2.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: #ffffff;
    }
    
    .chat-search-box .search-icon {
      position: absolute;
      left: 0.75rem;
      color: #8e8e8e;
    }
    
    .chats-list {
      max-height: calc(100vh - 300px);
      overflow-y: auto;
    }
    
    .chat-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
      border-radius: 12px;
      margin: 4px 8px;
      background: rgba(255, 255, 255, 0.02);
    }
    
    .chat-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .chat-avatar-container {
      position: relative;
      margin-right: 12px;
    }
    
    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-placeholder {
      color: white;
      font-weight: 600;
      font-size: 1.2rem;
    }
    
    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: #4CAF50;
      border: 2px solid var(--bg-dark);
      border-radius: 50%;
    }
    
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .chat-name {
      color: #ffffff;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .chat-time {
      color: #8e8e8e;
      font-size: 0.8rem;
    }
    
    .chat-preview {
      color: #aaa;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-info {
      flex: 1;
    }
    
    .chat-name {
      color: #ffffff;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .chat-area {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 140px);
      padding-bottom: 100px;
    }
    
    .chat-area.fullscreen {
      height: 100vh !important;
      padding-bottom: 0 !important;
    }
    
    .chat-area.fullscreen .whatsapp-chat {
      max-height: calc(100vh - 120px) !important;
    }
    
    .chat-header {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-darker);
    }
    
    .back-btn {
      background: none;
      border: none;
      color: #ffffff;
      cursor: pointer;
      padding: 0.5rem;
      margin-right: 0.5rem;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e1306c;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }
    
    .avatar-placeholder {
      font-size: 1.2rem;
    }
    
    .message-form {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      border-top: 1px solid var(--border);
      background: var(--bg-darker);
    }
    
    .message-form input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: #ffffff;
    }
    
    .message-form button {
      padding: 0.75rem 1.5rem;
      background: #0095f6;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .empty-chats, .empty-messages {
      text-align: center;
      padding: 2rem;
      color: #8e8e8e;
    }
    
    .chat-search-results {
      background: var(--bg-dark);
    }
    
    .chat-search-results .user-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }
    
    .chat-search-results .user-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .clear-search-btn {
      position: absolute;
      right: 0.75rem;
      background: none;
      border: none;
      color: #8e8e8e;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .clear-search-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    /* Profile Styles */
    .profile-section {
      padding: 2rem 1rem;
    }
    
    .profile-avatar-section {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .profile-avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #e1306c;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      overflow: hidden;
    }
    
    .profile-info-section {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .profile-username {
      color: #ffffff;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .profile-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .edit-profile-btn, .settings-btn {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: #ffffff;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .edit-profile-btn:hover, .settings-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .profile-stats-section {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .stat {
      text-align: center;
      cursor: pointer;
    }
    
    .stat-number {
      display: block;
      font-size: 1.2rem;
      font-weight: 600;
      color: #ffffff;
    }
    
    .stat-label {
      color: #8e8e8e;
      font-size: 0.9rem;
    }
    
    .profile-bio-section {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .profile-fullname {
      color: #ffffff;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .profile-bio-text {
      color: #8e8e8e;
      line-height: 1.4;
    }
    
    .profile-tabs {
      display: flex;
      justify-content: center;
      border-bottom: 1px solid var(--border);
    }
    
    .profile-tab {
      padding: 1rem 2rem;
      background: none;
      border: none;
      color: #8e8e8e;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .profile-tab.active {
      color: #ffffff;
      border-bottom-color: #ffffff;
    }
    
    .profile-content {
      min-height: 300px;
    }
    
    .profile-tab-content {
      padding: 1rem;
    }
    
    .loading, .no-content {
      text-align: center;
      padding: 2rem;
      color: #8e8e8e;
    }
    
    /* Search Styles */
    .search-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .search-bar {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .search-bar input {
      width: 100%;
      padding: 0.75rem 0.75rem 0.75rem 2.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: #ffffff;
    }
    
    .search-icon {
      position: absolute;
      left: 0.75rem;
      font-size: 1rem;
    }
    
    .search-content {
      padding: 1rem;
    }
    
    .recent-searches h3 {
      color: #ffffff;
      margin-bottom: 1rem;
    }
    
    .search-results {
      margin-top: 1rem;
    }
    
    .user-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
      border-radius: 12px;
      margin: 8px;
      background: rgba(255, 255, 255, 0.02);
    }
    
    .user-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .user-avatar {
      margin-right: 12px;
      position: relative;
    }
    
    .user-info {
      flex: 1;
      min-width: 0;
    }
    
    .user-name {
      color: #ffffff;
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 2px;
    }
    
    .user-fullname {
      color: #8e8e8e;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }
    
    .user-bio {
      color: #aaa;
      font-size: 0.8rem;
      line-height: 1.3;
    }
    
    .user-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    
    .btn-primary {
      background: #0095f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0077cc;
      transform: scale(1.05);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }
    
    .btn-accent {
      background: #4CAF50;
      color: white;
    }
    
    .btn-accent:hover {
      background: #45a049;
      transform: scale(1.05);
    }
    
    .all-users-header, .search-results-header {
      text-align: center;
      padding: 1.5rem;
      margin: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .all-users-header h3, .search-results-header h3 {
      color: #ffffff;
      margin: 0 0 8px 0;
      font-size: 1.2rem;
    }
    
    .all-users-header p {
      color: #8e8e8e;
      margin: 0;
      font-size: 0.9rem;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      color: #ffffff;
      font-weight: 600;
    }
    
    .no-results {
      text-align: center;
      padding: 2rem;
      color: #8e8e8e;
    }
    
    /* Post Styles */
    .post {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 2rem;
      overflow: hidden;
    }
    
    .post-image {
      width: 100%;
      max-height: 600px;
      object-fit: cover;
      display: block;
    }
    
    .post-caption {
      padding: 0 1rem 0.5rem;
      color: #ffffff;
      line-height: 1.4;
    }
    
    .post-timestamp {
      padding: 0 1rem 1rem;
      color: #8e8e8e;
      font-size: 0.8rem;
    }
    
    /* Notification Styles */
    .notifications-container {
      padding: 1rem;
    }
    
    .notifications-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }
    
    .notification-tab {
      padding: 0.75rem 1rem;
      background: none;
      border: none;
      color: #8e8e8e;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .notification-tab.active {
      color: #ffffff;
      border-bottom-color: #ffffff;
    }
    
    .notifications-list {
      min-height: 300px;
    }
    
    /* Media Preview */
    .media-preview {
      margin: 1rem 0;
      text-align: center;
    }
    
    .media-preview img,
    .media-preview video {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
    }
    
    /* Reels Feed Styles */
    .reels-feed {
      position: relative;
      height: 100%;
      overflow: hidden;
    }
    
    .reel-video-item {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      transition: transform 0.3s ease;
    }
    
    .reel-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      cursor: pointer;
    }
    
    .reel-info {
      position: absolute;
      bottom: 80px;
      left: 20px;
      right: 80px;
      color: white;
      z-index: 10;
    }
    
    .reel-user {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .reel-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background: #e1306c;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }
    
    .reel-username {
      font-weight: 600;
      font-size: 14px;
    }
    
    .reel-caption {
      font-size: 14px;
      line-height: 1.4;
      margin-bottom: 8px;
    }
    
    .reel-actions {
      position: absolute;
      right: 20px;
      bottom: 80px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 10;
    }
    
    .reel-action-btn {
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }
    
    .reel-action-btn:hover {
      background: rgba(0,0,0,0.7);
      transform: scale(1.1);
    }
    
    .reel-action-btn.liked {
      color: #ff3040;
    }
    
    .reel-action-count {
      font-size: 12px;
      font-weight: 600;
      margin-top: 4px;
    }
    
    .reel-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
      z-index: 10;
    }
    
    .reel-control-btn {
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }
    
    .reel-control-btn:hover {
      background: rgba(0,0,0,0.7);
    }
    
    .reel-nav-btn {
      transition: all 0.2s;
    }
    
    .reel-nav-btn:hover {
      background: rgba(0,0,0,0.7) !important;
      transform: scale(1.1);
    }
  </style>
  
  <!-- Preload critical resources -->
  <link rel="preconnect" href="https://res.cloudinary.com">
  <link rel="dns-prefetch" href="https://mybgfmpzsfecadjeobns.supabase.co">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Ensure Supabase loads before proceeding
    if (!window.supabase) {
      console.error('Supabase failed to load from CDN');
      document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: white; background: #000; font-family: Arial;"><div style="text-align: center;"><h2>Loading Error</h2><p>Please refresh the page</p></div></div>';
    }
  </script>
</head>
<body class="theme-default">

  <header class="site-header">
    <div class="container header-inner">
      <div class="logo" style="display: flex; align-items: center; gap: 0.5rem;">
        <img src="l2.png" alt="YC Logo" style="width: 32px; height: 32px; border-radius: 50%;" />
        <h1 style="margin: 0; font-size: 1.2rem; background: var(--primary); -webkit-background-clip: text; background-clip: text; color: transparent;">GENZES CHATS</h1>
      </div>
      <nav class="nav">
        <button id="btn-logout" class="btn btn-danger" onclick="logout()">
          <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
          </svg>
          <span>Logout</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Loading Screen -->
    <div id="loadingScreen" style="display: flex; align-items: center; justify-content: center; height: 100vh; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: Arial; text-align: center;">
      <div>
        <div style="width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <h2 style="margin: 0 0 10px 0;">GENZES CHATS</h2>
        <p style="margin: 0; opacity: 0.8;">Loading your conversations...</p>
      </div>
    </div>
    
    <!-- App Panel -->
    <div id="appPanel" class="app-container hidden">
      <div class="app-header">
        <button id="backBtn" class="icon-btn" onclick="goToHome()" title="Back">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
        </button>
        <div class="app-title" style="display: flex; align-items: center; gap: 0.5rem;">
          <span id="sectionTitle">Home</span>
        </div>
        <div class="header-actions">
          <button class="icon-btn" onclick="showSection('notifications')" title="Activity">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
          </button>
          <button class="icon-btn" onclick="showSection('create')" title="Create">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="main-content">
        <!-- Home Section -->
        <div id="homeSection" class="content-section active">
          <div class="feed-container">
            <div id="feed"></div>
          </div>
        </div>

        <!-- Search Section -->
        <div id="searchSection" class="content-section">
          <div class="search-header">
            <div class="search-bar">
              <span class="search-icon">üîç</span>
              <input type="text" id="searchQuery" placeholder="Search" />
            </div>
          </div>
          <div class="search-content">
            <div class="recent-searches">
              <h3>Recent</h3>
              <div id="recentSearches"></div>
            </div>
            <div id="searchResults" class="search-results"></div>
          </div>
        </div>

        <!-- Reels Section -->
        <div id="reelsSection" class="content-section">
          <div class="reels-feed-container" style="position: relative; height: calc(100vh - 140px); overflow: hidden; background: #000;">
            <div id="reelsFeed" class="reels-feed" style="height: 100%; position: relative;"></div>
            
            <button id="reelUpBtn" class="reel-nav-btn" onclick="navigateReel('up')" style="position: absolute; top: 20px; right: 20px; z-index: 100; background: rgba(0,0,0,0.5); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
              </svg>
            </button>
            
            <button id="reelDownBtn" class="reel-nav-btn" onclick="navigateReel('down')" style="position: absolute; bottom: 100px; right: 20px; z-index: 100; background: rgba(0,0,0,0.5); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
              </svg>
            </button>
            

          </div>
        </div>

        <!-- Messages Section -->
        <div id="messagesSection" class="content-section">
          <div class="messages-header">
            <div class="messages-title">
              <h2>Chats</h2>
              <div style="display: flex; gap: 8px;">
                <button id="showSharedPosts" class="icon-btn" onclick="showSharedPostsModal()" title="Shared Posts">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                  </svg>
                </button>
                <button id="refreshMessages" class="icon-btn" onclick="refreshMessages()" title="Refresh Messages">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="chat-search-container" id="chatSearchContainer">
              <div class="chat-search-box">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" id="chatSearchInput" placeholder="Search or start new chat" autocomplete="off">
                <button id="clearChatSearch" class="clear-search-btn hidden" onclick="clearChatSearch()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div id="chatSearchResults" class="chat-search-results hidden" style="max-height: calc(100vh - 300px); overflow-y: auto;"></div>
          <div id="chatsList" class="chats-list"></div>
          <div id="chatArea" class="chat-area hidden">
            <div class="chat-header">
              <button id="backToChats" class="back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
              </button>
              <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                <div class="chat-avatar" style="width: 32px; height: 32px;">
                  <div class="avatar-placeholder">?</div>
                </div>
                <div>
                  <div class="chat-name" style="font-size: 16px; font-weight: 600; color: #ffffff;">Chat</div>
                  <div id="chatStatus" style="font-size: 12px; color: #8e8e8e;">Offline</div>
                </div>
              </div>

              <button id="blockUserBtn" class="icon-btn" onclick="blockCurrentUser()" title="Block User" style="color: #ff4757;">
                <img src="https://cdn-icons-png.flaticon.com/512/16362/16362919.png" alt="Block" style="width: 20px; height: 20px; filter: brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%);" />
              </button>
              <button id="hideChatBtn" class="icon-btn" onclick="hideCurrentChat()" title="Hide Chat" style="color: #8e8e8e;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                </svg>
              </button>
              <button id="themesBtn" class="icon-btn" onclick="showChatThemes()" title="Chat Themes" style="color: #8e8e8e;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                </svg>
              </button>
              <button id="maximizeBtn" class="icon-btn" onclick="toggleFullscreenChat()" title="Fullscreen Chat" style="color: #8e8e8e;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
              </button>
            </div>
            <div id="messages" class="whatsapp-chat"></div>
            <div id="typingIndicator" class="typing-indicator" style="display: none; padding: 8px 16px; color: #8e8e8e; font-size: 12px; font-style: italic;">
              <span class="typing-dots">
                <span>‚Ä¢</span><span>‚Ä¢</span><span>‚Ä¢</span>
              </span>
              <span class="typing-text">typing...</span>
            </div>
            <form id="messageForm" class="message-form">
              <input type="text" id="messageInput" placeholder="Message..." autocomplete="off" />
              <button type="submit">Send</button>
            </form>
          </div>
        </div>

        <!-- Create Section -->
        <div id="createSection" class="content-section">
          <div class="section-header" style="padding: 1rem; text-align: center;">
            <h2 style="margin: 0; color: #fff;">Create Content</h2>
            <p style="margin: 0.5rem 0 0 0; color: #8e8e8e; font-size: 0.9rem;">Share your moments with the world</p>
          </div>
          <div class="create-options">
            <div class="create-grid">
              <button id="createPost" class="create-option" onclick="openCreatePostModal()">
                <div class="create-icon">
                  <img src="https://cdn-icons-png.flaticon.com/512/3388/3388973.png" alt="Post" style="width: 40px; height: 40px; filter: brightness(0) invert(1);" />
                </div>
                <span>Post</span>
              </button>
              <button id="createReel" class="create-option" onclick="openCreateReelModal()">
                <div class="create-icon">
                  <img src="https://cdn-icons-png.flaticon.com/512/11820/11820224.png" alt="Reel" style="width: 40px; height: 40px; filter: brightness(0) invert(1);" />
                </div>
                <span>Reel</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Notifications Section -->
        <div id="notificationsSection" class="content-section">
          <div class="section-header" style="padding: 1rem;">
            <h2 style="margin: 0; color: #fff;">Activity</h2>
          </div>
          <div class="notifications-container">
            <div class="notifications-tabs">
              <button class="notification-tab active" data-tab="all">All</button>
              <button class="notification-tab" data-tab="likes">Likes</button>
              <button class="notification-tab" data-tab="follows">Follows</button>
              <button class="notification-tab" data-tab="comments">Comments</button>
            </div>
            <div class="notifications-list" id="notificationsList">
              <!-- Notifications will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="content-section">
          <div class="profile-section">
            <!-- Profile Avatar Section -->
            <div class="profile-avatar-section">
              <div class="profile-avatar-large" id="profileAvatar">
                <span id="profileInitial">U</span>
              </div>
            </div>
            
            <!-- Profile Info Section -->
            <div class="profile-info-section">
              <h2 class="profile-username" id="profileUsername">username</h2>
              <div class="profile-actions">
                <button class="edit-profile-btn" onclick="editProfile()" title="Edit Profile">Edit Profile</button>
                <button id="openSettings" class="settings-btn" title="Settings">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8M12,2A1.31,1.31 0 0,0 10.69,3.31L10.5,4.5C10.5,4.5 10.5,4.5 10.5,4.5C9.97,4.5 9.46,4.67 9.04,5L8.04,4.32C7.64,4 7.1,4 6.69,4.32L5.81,5.19C5.5,5.5 5.5,6 5.81,6.31L6.5,7C6.17,7.42 6,7.93 6,8.46V8.5L4.69,8.69A1.31,1.31 0 0,0 3.31,10.69V13.31A1.31,1.31 0 0,0 4.69,15.31L6,15.5C6,16.03 6.17,16.54 6.5,16.96L5.81,17.69C5.5,18 5.5,18.5 5.81,18.81L6.69,19.69C7,20 7.5,20 7.81,19.69L8.5,19C8.92,19.33 9.43,19.5 9.96,19.5H10L10.31,20.69A1.31,1.31 0 0,0 12,22A1.31,1.31 0 0,0 13.69,20.69L14,19.5C14.53,19.5 15.04,19.33 15.46,19L16.19,19.69C16.5,20 17,20 17.31,19.69L18.19,18.81C18.5,18.5 18.5,18 18.19,17.69L17.5,17C17.83,16.58 18,16.07 18,15.54V15.5L19.31,15.31A1.31,1.31 0 0,0 20.69,13.31V10.69A1.31,1.31 0 0,0 19.31,8.69L18,8.5C18,7.97 17.83,7.46 17.5,7.04L18.19,6.31C18.5,6 18.5,5.5 18.19,5.19L17.31,4.31C17,4 16.5,4 16.19,4.31L15.5,5C15.08,4.67 14.57,4.5 14.04,4.5H14L13.69,3.31A1.31,1.31 0 0,0 12,2Z"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Profile Stats Section -->
            <div class="profile-stats-section">
              <div class="stat" onclick="showProfileTab('posts')">
                <span class="stat-number" id="postsCount">0</span>
                <span class="stat-label">posts</span>
              </div>
              <div class="stat" onclick="showFollowers()" style="cursor: pointer;">
                <span class="stat-number" id="followersCount">0</span>
                <span class="stat-label">followers</span>
              </div>
              <div class="stat" onclick="showFollowing()" style="cursor: pointer;">
                <span class="stat-number" id="followingCount">0</span>
                <span class="stat-label">following</span>
              </div>
            </div>
            
            <!-- Profile Bio Section -->
            <div class="profile-bio-section">
              <div class="profile-fullname" id="profileFullname">Full Name</div>
              <div class="profile-bio-text" id="profileBio">Bio goes here...</div>
              <div class="profile-links" id="profileLinks"></div>
            </div>
          </div>
          
          <!-- Profile Tabs -->
          <div class="profile-tabs">
            <button class="profile-tab active" data-tab="posts">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
              </svg>
            </button>
            <button class="profile-tab" data-tab="reels">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
              </svg>
            </button>
            <button class="profile-tab" data-tab="tagged">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </button>
          </div>
          
          <!-- Profile Content -->
          <div class="profile-content">
            <div id="postsContent" class="profile-tab-content">
              <div class="loading">Loading posts...</div>
            </div>
            <div id="reelsContent" class="profile-tab-content hidden">
              <div class="loading">Loading reels...</div>
            </div>
            <div id="taggedContent" class="profile-tab-content hidden">
              <div class="no-content">No tagged posts yet</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Navigation -->
      <div class="bottom-nav">
        <button class="nav-btn active" data-section="home">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
          </span>
          <span class="nav-label">Home</span>
        </button>
        <button class="nav-btn" data-section="search">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
          </span>
          <span class="nav-label">Search</span>
        </button>
        <button class="nav-btn" data-section="reels">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
            </svg>
          </span>
          <span class="nav-label">Reels</span>
        </button>
        <button class="nav-btn" data-section="messages">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
          </span>
          <span class="nav-label">Messages</span>
        </button>
        <button class="nav-btn" data-section="profile">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </span>
          <span class="nav-label">Profile</span>
        </button>
      </div>
    </div>

    <!-- Modals -->
    <div id="createPostModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog">
        <div class="modal-header">
          <h3>Create Post</h3>
          <button id="closeCreatePost" class="close-btn">√ó</button>
        </div>
        <form id="createPostForm" class="modal-form">
          <label>Media
            <button type="button" id="btnPickMedia" class="upload-btn">Choose Photo/Video</button>
            <input type="file" id="postImage" accept="image/*,video/*" capture="environment" style="display: none;" />
            <div id="mediaSelected" style="margin-top: 8px; font-size: 0.9em; color: #666;"></div>
          </label>
          <div id="postPreview" class="media-preview"></div>
          <label>Caption
            <textarea id="postCaption" rows="3" placeholder="Write a caption..."></textarea>
          </label>
          <label>Audience
            <select id="postAudience">
              <option value="public">Public</option>
              <option value="followers">Followers only</option>
              <option value="close_friends">Close friends</option>
            </select>
          </label>
          <div class="modal-actions">
            <button type="button" id="cancelCreatePost" class="cancel-btn">Cancel</button>
            <button type="submit" class="save-btn" id="postSubmitBtn">Share</button>
          </div>
        </form>
      </div>
    </div>

    <div id="createReelModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog">
        <div class="modal-header">
          <h3>Create Reel</h3>
          <button id="closeCreateReel" class="close-btn">√ó</button>
        </div>
        <form id="createReelForm" class="modal-form">
          <label>Video
            <button type="button" id="btnPickReelVideo" class="upload-btn">Choose Video</button>
            <input type="file" id="reelVideo" accept="video/*" capture="environment" style="display: none;" />
            <div id="reelVideoSelected" style="margin-top: 8px; font-size: 0.9em; color: #666;"></div>
          </label>
          <div id="reelPreview" class="media-preview"></div>
          <label>Caption
            <textarea id="reelCaption" rows="3" placeholder="Write a caption..."></textarea>
          </label>
          <label>Audience
            <select id="reelAudience">
              <option value="public">Public</option>
              <option value="followers">Followers only</option>
              <option value="close_friends">Close friends</option>
            </select>
          </label>
          <div class="modal-actions">
            <button type="button" id="cancelCreateReel" class="cancel-btn">Cancel</button>
            <button type="submit" class="save-btn" id="reelSubmitBtn">Share Reel</button>
          </div>
        </form>
      </div>
    </div>

    <div id="settingsModal" class="modal settings-modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog">
        <div class="settings-header">
          <h3>Settings</h3>
          <button id="closeSettings" class="close-btn">√ó</button>
        </div>
        <div class="settings-body">
          <div class="settings-item" onclick="showEditProfile()">
            <h4>Edit Profile</h4>
            <p>Change your username, bio, and profile picture</p>
          </div>
          <div class="settings-item" onclick="accountPrivacy()">
            <h4>Account Privacy</h4>
            <p>Manage who can see your content</p>
          </div>
          <div class="settings-item" onclick="logout()">
            <h4>üö™ Logout</h4>
            <p>Sign out of your account</p>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script src="js/fastLoad.js"></script>
  <script src="js/supabaseClient.js"></script>
  <script src="js/localAuth.js"></script>
  <script src="enhanced-ui.js"></script>
  <script src="music-features.js"></script>
  <script src="error-fixes.js"></script>
  <script src="performance-optimizations.js"></script>

  <script>
    // Global variables
    window.currentUser = null;
    window.currentChat = null;
    window.messageSubscription = null;
    window.presenceSubscription = null;
    window.userPresence = new Map(); // Track user presence

    // Auth check
    async function checkAuth() {
      if (!window.sb) {
        window.location.href = 'auth.html';
        return;
      }
      
      const { data: { session } } = await window.sb.auth.getSession();
      if (!session?.user) {
        window.location.href = 'auth.html';
        return;
      }
      
      window.currentUser = session.user;
      document.getElementById('appPanel').classList.remove('hidden');
      loadChats();
      loadFeed();
    }

    // WhatsApp-style loadMessages function
    async function loadMessages(partnerId) {
      try {
        const { data: messages, error } = await window.sb
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${window.currentUser.id},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${window.currentUser.id})`)
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        const messagesContainer = document.getElementById('messages');
        if (!messagesContainer) return;
        
        messagesContainer.className = 'whatsapp-chat';
        let html = '';
        
        if (messages?.length) {
          let lastDate = '';
          
          for (let index = 0; index < messages.length; index++) {
            const message = messages[index];
            const isMe = message.sender_id === window.currentUser.id;
            const messageDate = new Date(message.created_at).toDateString();
            const editedText = message.edited ? ' (edited)' : '';
            
            // Add date separator
            if (messageDate !== lastDate) {
              html += `<div class="date-separator">${formatDate(message.created_at)}</div>`;
              lastDate = messageDate;
            }
            
            // Group consecutive messages from same sender
            const prevMessage = messages[index - 1];
            const nextMessage = messages[index + 1];
            const isFirstInGroup = !prevMessage || prevMessage.sender_id !== message.sender_id || messageDate !== new Date(prevMessage.created_at).toDateString();
            const isLastInGroup = !nextMessage || nextMessage.sender_id !== message.sender_id || new Date(nextMessage.created_at).toDateString() !== messageDate;
            
            if (message.message_type === 'shared_post' && message.shared_post_id) {
              try {
                const { data: post } = await window.sb
                  .from('posts')
                  .select('id, caption, image_url, user_id')
                  .eq('id', message.shared_post_id)
                  .single();
                
                if (post) {
                  const isVideo = post.image_url && (post.image_url.includes('video') || post.image_url.startsWith('data:video'));
                  
                  html += `
                    <div class="message-wrapper ${isMe ? 'me' : 'them'}">
                      <div class="message ${isFirstInGroup ? 'first' : ''} ${isLastInGroup ? 'last' : ''}" data-message-id="${message.id}">
                        <div class="message-content">
                          ${message.content ? `<div class="message-text">${message.content}</div>` : ''}
                          <div class="shared-post" onclick="openContentPopup('${post.id}', '${isVideo ? 'reel' : 'post'}')" style="border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; margin-top: 8px; cursor: pointer; max-width: 250px;">
                            ${post.image_url ? (isVideo ? 
                              `<video src="${post.image_url}" style="width: 100%; height: 150px; object-fit: cover;" muted />` :
                              `<img src="${post.image_url}" style="width: 100%; height: 150px; object-fit: cover;" />`
                            ) : ''}
                            ${post.caption ? `<div style="padding: 8px; font-size: 12px; color: #8e8e8e;">${post.caption}</div>` : ''}
                          </div>
                          ${isLastInGroup ? `
                            <div class="message-time">
                              ${formatTime(message.created_at)}
                              ${isMe ? '<span class="message-status">‚úì‚úì</span>' : ''}
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                } else {
                  html += `
                    <div class="message-wrapper ${isMe ? 'me' : 'them'}">
                      <div class="message ${isFirstInGroup ? 'first' : ''} ${isLastInGroup ? 'last' : ''}" data-message-id="${message.id}">
                        <div class="message-content">
                          <div class="message-text">üìù Shared post (unavailable)</div>
                          ${isLastInGroup ? `
                            <div class="message-time">
                              ${formatTime(message.created_at)}
                              ${isMe ? '<span class="message-status">‚úì‚úì</span>' : ''}
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }
              } catch (error) {
                console.log('Error loading shared post:', error);
                html += `
                  <div class="message-wrapper ${isMe ? 'me' : 'them'}">
                    <div class="message ${isFirstInGroup ? 'first' : ''} ${isLastInGroup ? 'last' : ''}" data-message-id="${message.id}">
                      <div class="message-content">
                        <div class="message-text">üìù Shared post (unavailable)</div>
                        ${isLastInGroup ? `
                          <div class="message-time">
                            ${formatTime(message.created_at)}
                            ${isMe ? '<span class="message-status">‚úì‚úì</span>' : ''}
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  </div>
                `;
              }
            } else {
              html += `
                <div class="message-wrapper ${isMe ? 'me' : 'them'}">
                  <div class="message ${isFirstInGroup ? 'first' : ''} ${isLastInGroup ? 'last' : ''}" data-message-id="${message.id}">
                    <div class="message-content">
                      <div class="message-text">${message.content || ''}${editedText}</div>
                      ${isLastInGroup ? `
                        <div class="message-time">
                          ${formatTime(message.created_at)}
                          ${isMe ? '<span class="message-status">‚úì‚úì</span>' : ''}
                        </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
              `;
            }
          }
        } else {
          html = `
            <div class="empty-messages">
              <div class="empty-icon">üí¨</div>
              <h3>No messages yet</h3>
              <p>Send a message to start the conversation</p>
            </div>
          `;
        }
        
        messagesContainer.innerHTML = html;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
      } catch (error) {
        console.error('Error loading messages:', error);
        const messagesContainer = document.getElementById('messages');
        if (messagesContainer) {
          messagesContainer.innerHTML = `
            <div class="empty-messages">
              <div class="empty-icon">‚ö†Ô∏è</div>
              <p>Error loading messages</p>
            </div>
          `;
        }
      }
    }

    // Format date function
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const diffTime = today - messageDate;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return date.toLocaleDateString('en-US', { weekday: 'long' });
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Format time function
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
      return Math.floor(diff / 86400000) + 'd';
    }

    // Send message
    async function sendMessage(e) {
      e.preventDefault();
      if (!window.currentChat) return;
      
      const input = document.getElementById('messageInput');
      const sendBtn = document.querySelector('#messageForm button[type="submit"]');
      const content = input.value.trim();
      if (!content) return;
      
      // Disable input and button while sending
      input.disabled = true;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      try {
        const { error } = await window.sb.from('messages').insert({
          sender_id: window.currentUser.id,
          receiver_id: window.currentChat.partnerId,
          content: content
        });
        
        if (error) throw error;
        input.value = '';
        
      } catch (error) {
        console.error('Error sending message:', error);
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff4757; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        errorMsg.textContent = 'Failed to send message';
        document.body.appendChild(errorMsg);
        setTimeout(() => errorMsg.remove(), 3000);
      } finally {
        // Re-enable input and button
        input.disabled = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        input.focus();
      }
    }

    // Open chat
    function openChat(partnerId, partnerName) {
      console.log('Opening chat with:', partnerId, partnerName);
      
      // Unsubscribe from previous chat
      if (window.messageSubscription) {
        window.messageSubscription.unsubscribe();
        window.messageSubscription = null;
      }
      
      document.getElementById('chatsList').style.display = 'none';
      document.getElementById('chatArea').classList.remove('hidden');
      document.getElementById('chatSearchContainer').style.display = 'none';
      document.querySelector('.chat-name').textContent = partnerName;
      
      // Set current chat with proper structure
      window.currentChat = { 
        partnerId: partnerId, 
        partnerName: partnerName 
      };
      
      // Update chat status with presence
      const statusEl = document.getElementById('chatStatus');
      if (statusEl) {
        const presence = window.userPresence.get(partnerId);
        if (presence?.online) {
          statusEl.textContent = 'Online';
          statusEl.style.color = '#4CAF50';
        } else if (presence?.lastSeen) {
          statusEl.textContent = `Last seen ${formatTime(presence.lastSeen)}`;
          statusEl.style.color = '#8e8e8e';
        } else {
          statusEl.textContent = 'Offline';
          statusEl.style.color = '#8e8e8e';
        }
      }
      
      console.log('Current chat set to:', window.currentChat);
      
      loadMessages(partnerId);
      setupMessageSubscription(partnerId);
      
      // Load saved chat theme
      setTimeout(() => {
        loadChatTheme();
      }, 100);
    }

    // Setup presence tracking with database
    function setupPresenceTracking() {
      if (!window.sb || !window.currentUser) return;
      
      console.log('Setting up presence tracking');
      
      // Set user as online in database
      updateUserPresence(true);
      
      // Subscribe to presence changes
      window.presenceSubscription = window.sb
        .channel('user-presence')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'user_presence'
        }, (payload) => {
          console.log('Presence change:', payload);
          handlePresenceChange(payload);
        })
        .subscribe((status) => {
          console.log('Presence subscription status:', status);
        });
      
      // Update presence every 30 seconds
      setInterval(() => {
        if (!document.hidden) {
          updateUserPresence(true);
        }
      }, 30000);
      
      // Handle page visibility changes
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          updateUserPresence(false);
        } else {
          updateUserPresence(true);
        }
      });
      
      // Handle beforeunload to mark offline
      window.addEventListener('beforeunload', () => {
        navigator.sendBeacon('/api/offline', JSON.stringify({ userId: window.currentUser.id }));
        updateUserPresence(false);
      });
      
      // Load initial presence data
      loadPresenceData();
    }
    
    // Update user presence in database
    async function updateUserPresence(isOnline) {
      if (!window.sb || !window.currentUser) return;
      
      try {
        const { error } = await window.sb
          .from('user_presence')
          .upsert({
            user_id: window.currentUser.id,
            is_online: isOnline,
            last_seen: new Date().toISOString()
          });
        
        if (error) throw error;
        
      } catch (error) {
        console.error('Error updating presence:', error);
      }
    }
    
    // Load presence data for all users
    async function loadPresenceData() {
      if (!window.sb) return;
      
      try {
        const { data: presenceData } = await window.sb
          .from('user_presence')
          .select('*');
        
        if (presenceData) {
          window.userPresence.clear();
          presenceData.forEach(presence => {
            const lastSeen = new Date(presence.last_seen);
            const isRecentlyOnline = presence.is_online && (Date.now() - lastSeen.getTime()) < 120000; // 2 minutes
            
            window.userPresence.set(presence.user_id, {
              online: isRecentlyOnline,
              lastSeen: lastSeen
            });
          });
          
          updatePresenceIndicators();
        }
        
      } catch (error) {
        console.error('Error loading presence data:', error);
      }
    }
    
    // Handle presence changes from subscription
    function handlePresenceChange(payload) {
      const { eventType, new: newRecord, old: oldRecord } = payload;
      
      if (eventType === 'INSERT' || eventType === 'UPDATE') {
        const lastSeen = new Date(newRecord.last_seen);
        const isRecentlyOnline = newRecord.is_online && (Date.now() - lastSeen.getTime()) < 120000;
        
        window.userPresence.set(newRecord.user_id, {
          online: isRecentlyOnline,
          lastSeen: lastSeen
        });
      } else if (eventType === 'DELETE' && oldRecord) {
        window.userPresence.set(oldRecord.user_id, {
          online: false,
          lastSeen: new Date(oldRecord.last_seen)
        });
      }
      
      updatePresenceIndicators();
    }
    
    // Update presence indicators in UI
    function updatePresenceIndicators() {
      // Update chat list presence indicators
      document.querySelectorAll('.chat-item').forEach(chatItem => {
        const userId = chatItem.dataset.userId;
        if (userId) {
          const presenceIndicator = chatItem.querySelector('.presence-indicator');
          const statusText = chatItem.querySelector('.chat-info div:last-child');
          const presence = window.userPresence.get(userId);
          
          if (presenceIndicator) {
            if (presence?.online) {
              presenceIndicator.style.background = '#4CAF50';
              presenceIndicator.title = 'Online';
              if (statusText) {
                statusText.textContent = 'Online';
                statusText.style.color = '#4CAF50';
              }
            } else {
              presenceIndicator.style.background = '#8e8e8e';
              const lastSeenText = presence?.lastSeen ? formatTime(presence.lastSeen) : 'Unknown';
              presenceIndicator.title = `Last seen ${lastSeenText}`;
              if (statusText) {
                statusText.textContent = `Last seen ${lastSeenText}`;
                statusText.style.color = '#8e8e8e';
              }
            }
          }
        }
      });
      
      // Update search results presence indicators
      document.querySelectorAll('.user-item').forEach(userItem => {
        const userId = userItem.dataset.userId;
        if (userId) {
          const presenceIndicator = userItem.querySelector('.presence-indicator');
          const statusText = userItem.querySelector('.user-info div:last-child');
          const presence = window.userPresence.get(userId);
          
          if (presenceIndicator) {
            if (presence?.online) {
              presenceIndicator.style.background = '#4CAF50';
              presenceIndicator.title = 'Online';
              if (statusText) {
                statusText.textContent = 'Online';
                statusText.style.color = '#4CAF50';
              }
            } else {
              presenceIndicator.style.background = '#8e8e8e';
              const lastSeenText = presence?.lastSeen ? formatTime(presence.lastSeen) : 'Unknown';
              presenceIndicator.title = `Last seen ${lastSeenText}`;
              if (statusText) {
                statusText.textContent = `Last seen ${lastSeenText}`;
                statusText.style.color = '#8e8e8e';
              }
            }
          }
        }
      });
      
      // Update current chat status
      if (window.currentChat) {
        const presence = window.userPresence.get(window.currentChat.partnerId);
        const statusEl = document.getElementById('chatStatus');
        
        if (statusEl) {
          if (presence?.online) {
            statusEl.textContent = 'Online';
            statusEl.style.color = '#4CAF50';
          } else if (presence?.lastSeen) {
            statusEl.textContent = `Last seen ${formatTime(presence.lastSeen)}`;
            statusEl.style.color = '#8e8e8e';
          } else {
            statusEl.textContent = 'Offline';
            statusEl.style.color = '#8e8e8e';
          }
        }
      }
    }
    
    // Setup real-time chat list subscription
    function setupChatListSubscription() {
      if (!window.sb || !window.currentUser) return;
      
      console.log('Setting up chat list subscription');
      
      // Subscribe to new messages to update chat list
      window.sb
        .channel('chat-list')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `or(sender_id.eq.${window.currentUser.id},receiver_id.eq.${window.currentUser.id})`
        }, (payload) => {
          console.log('New message for chat list:', payload);
          // Only refresh if we're not in an active chat or if it's from a different user
          if (!window.currentChat || 
              (payload.new.sender_id !== window.currentChat.partnerId && 
               payload.new.receiver_id !== window.currentChat.partnerId)) {
            loadChats();
          }
        })
        .subscribe((status) => {
          console.log('Chat list subscription status:', status);
        });
    }
    

    
    // Setup real-time message subscription
    function setupMessageSubscription(partnerId) {
      if (!window.sb || !window.currentUser) return;
      
      console.log('Setting up message subscription for:', partnerId);
      
      // Subscribe to new messages in this conversation
      window.messageSubscription = window.sb
        .channel(`messages-${partnerId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `or(and(sender_id.eq.${window.currentUser.id},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${window.currentUser.id}))`
        }, (payload) => {
          console.log('New message received:', payload);
          addMessageToChat(payload.new);
        })
        .subscribe((status) => {
          console.log('Message subscription status:', status);
        });
    }
    
    // Play notification sound
    function playNotificationSound() {
      try {
        // Create a simple notification sound using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (error) {
        console.log('Could not play notification sound:', error);
      }
    }
    
    // Add new message to chat in real-time
    function addMessageToChat(message) {
      if (!window.currentChat || !message) return;
      
      const messagesContainer = document.getElementById('messages');
      if (!messagesContainer) return;
      
      const isMe = message.sender_id === window.currentUser.id;
      const messageDate = new Date(message.created_at).toDateString();
      
      // Play notification sound for incoming messages (not our own)
      if (!isMe) {
        playNotificationSound();
      }
      
      // Check if we need a date separator
      const lastMessage = messagesContainer.lastElementChild;
      let needDateSeparator = false;
      
      if (!lastMessage || !lastMessage.classList.contains('message-wrapper')) {
        needDateSeparator = true;
      } else {
        const lastMessageDate = lastMessage.dataset.messageDate;
        if (lastMessageDate !== messageDate) {
          needDateSeparator = true;
        }
      }
      
      let html = '';
      
      if (needDateSeparator) {
        html += `<div class="date-separator">${formatDate(message.created_at)}</div>`;
      }
      
      html += `
        <div class="message-wrapper ${isMe ? 'me' : 'them'}" data-message-date="${messageDate}">
          <div class="message">
            <div class="message-content">
              <div class="message-text">${message.content}</div>
              <div class="message-time">${formatTime(message.created_at)}</div>
            </div>
          </div>
        </div>
      `;
      
      messagesContainer.insertAdjacentHTML('beforeend', html);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Add smooth scroll animation
      const newMessage = messagesContainer.lastElementChild;
      if (newMessage && newMessage.classList.contains('message-wrapper')) {
        newMessage.style.opacity = '0';
        newMessage.style.transform = 'translateY(20px)';
        setTimeout(() => {
          newMessage.style.transition = 'all 0.3s ease';
          newMessage.style.opacity = '1';
          newMessage.style.transform = 'translateY(0)';
        }, 10);
      }
    }

    // Load messages with WhatsApp-style rendering
    async function loadMessages(partnerId) {
      try {
        const { data: messages, error } = await window.sb
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${window.currentUser.id},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${window.currentUser.id})`)
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        const messagesContainer = document.getElementById('messages');
        messagesContainer.className = 'whatsapp-chat';
        let html = '';
        
        if (messages?.length) {
          let lastDate = '';
          
          for (let index = 0; index < messages.length; index++) {
            const message = messages[index];
            const isMe = message.sender_id === window.currentUser.id;
            const messageDate = new Date(message.created_at).toDateString();
            
            // Add date separator
            if (messageDate !== lastDate) {
              html += `<div class="date-separator">${formatDate(message.created_at)}</div>`;
              lastDate = messageDate;
            }
            
            if (message.message_type === 'shared_post' && message.shared_post_id) {
              try {
                const { data: post } = await window.sb
                  .from('posts')
                  .select('id, caption, image_url, user_id')
                  .eq('id', message.shared_post_id)
                  .single();
                
                if (post) {
                  const isVideo = post.image_url && (post.image_url.includes('video') || post.image_url.startsWith('data:video'));
                  
                  html += `
                    <div class="message-wrapper ${isMe ? 'me' : 'them'}" data-message-date="${messageDate}">
                      <div class="message">
                        <div class="message-content">
                          ${message.content ? `<div class="message-text">${message.content}</div>` : ''}
                          <div class="shared-post" onclick="openContentPopup('${post.id}', '${isVideo ? 'reel' : 'post'}')" style="border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; margin-top: 8px; cursor: pointer; max-width: 250px;">
                            ${post.image_url ? (isVideo ? 
                              `<video src="${post.image_url}" style="width: 100%; height: 150px; object-fit: cover;" muted />` :
                              `<img src="${post.image_url}" style="width: 100%; height: 150px; object-fit: cover;" />`
                            ) : ''}
                            ${post.caption ? `<div style="padding: 8px; font-size: 12px; color: #8e8e8e;">${post.caption}</div>` : ''}
                          </div>
                          <div class="message-time">${formatTime(message.created_at)}</div>
                        </div>
                      </div>
                    </div>
                  `;
                } else {
                  html += `
                    <div class="message-wrapper ${isMe ? 'me' : 'them'}" data-message-date="${messageDate}">
                      <div class="message">
                        <div class="message-content">
                          <div class="message-text">üìù Shared post (unavailable)</div>
                          <div class="message-time">${formatTime(message.created_at)}</div>
                        </div>
                      </div>
                    </div>
                  `;
                }
              } catch (error) {
                console.log('Error loading shared post:', error);
                html += `
                  <div class="message-wrapper ${isMe ? 'me' : 'them'}" data-message-date="${messageDate}">
                    <div class="message">
                      <div class="message-content">
                        <div class="message-text">üìù Shared post (unavailable)</div>
                        <div class="message-time">${formatTime(message.created_at)}</div>
                      </div>
                    </div>
                  </div>
                `;
              }
            } else {
              html += `
                <div class="message-wrapper ${isMe ? 'me' : 'them'}" data-message-date="${messageDate}">
                  <div class="message">
                    <div class="message-content">
                      <div class="message-text">${message.content || ''}</div>
                      <div class="message-time">${formatTime(message.created_at)}</div>
                    </div>
                  </div>
                </div>
              `;
            }
          }
        } else {
          html = '<div class="empty-messages">No messages yet. Start the conversation!</div>';
        }
        
        messagesContainer.innerHTML = html;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }
    
    // Format date for message separators
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const diffTime = today - messageDate;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Load chats
    async function loadChats() {
      const { data: messages } = await window.sb
        .from('messages')
        .select('sender_id, receiver_id')
        .or(`sender_id.eq.${window.currentUser.id},receiver_id.eq.${window.currentUser.id}`);
      
      const userIds = new Set();
      messages?.forEach(msg => {
        const otherId = msg.sender_id === window.currentUser.id ? msg.receiver_id : msg.sender_id;
        if (otherId !== window.currentUser.id) userIds.add(otherId);
      });
      
      // Get blocked users
      const { data: blockedUsers } = await window.sb
        .from('blocked_users')
        .select('blocked_id')
        .eq('blocker_id', window.currentUser.id);
      
      const blockedIds = new Set(blockedUsers?.map(b => b.blocked_id) || []);
      
      // Get hidden chats
      const hiddenChats = JSON.parse(localStorage.getItem('hiddenChats') || '[]');
      const hiddenIds = new Set(hiddenChats);
      
      // Load fresh presence data
      await loadPresenceData();
      
      const container = document.getElementById('chatsList');
      let html = '';
      
      if (userIds.size > 0) {
        for (const userId of userIds) {
          // Skip blocked and hidden users
          if (blockedIds.has(userId) || hiddenIds.has(userId)) continue;
          
          const { data: profile } = await window.sb
            .from('profiles')
            .select('username')
            .eq('id', userId)
            .single();
          
          if (profile) {
            const presence = window.userPresence.get(userId);
            const isOnline = presence?.online || false;
            const lastSeenText = presence?.lastSeen ? formatTime(presence.lastSeen) : 'Unknown';
            
            html += `
              <div class="chat-item" data-user-id="${userId}" onclick="openChat('${userId}', '${profile.username}')" style="position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="position: relative;">
                    <div class="chat-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                      ${profile.username[0].toUpperCase()}
                    </div>
                    <div class="presence-indicator" style="position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${isOnline ? '#4CAF50' : '#8e8e8e'}; border: 2px solid var(--bg-dark);" title="${isOnline ? 'Online' : `Last seen ${lastSeenText}`}"></div>
                  </div>
                  <div class="chat-info">
                    <div class="chat-name">${profile.username}</div>
                    <div style="font-size: 12px; color: ${isOnline ? '#4CAF50' : '#8e8e8e'};">${isOnline ? 'Online' : `Last seen ${lastSeenText}`}</div>
                  </div>
                </div>
              </div>
            `;
          }
        }
      }
      
      if (!html) {
        html = '<div class="empty-chats">No chats yet. Search for users to start messaging.</div>';
      }
      
      container.innerHTML = html;
    }

    // Load feed
    async function loadFeed() {
      try {
        const { data: posts, error } = await window.sb
          .from('posts')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(20);
        
        if (error) throw error;
        
        const feedContainer = document.getElementById('feed');
        if (!feedContainer) return;
        
        let html = '';
        
        if (posts?.length) {
          for (const post of posts) {
            let user = null;
            try {
              const { data: profile } = await window.sb
                .from('profiles')
                .select('username, avatar_url, full_name')
                .eq('id', post.user_id)
                .single();
              user = profile;
            } catch (err) {
              console.log('Profile not found for user:', post.user_id);
            }
            
            const isVideo = post.image_url && (post.image_url.includes('video') || post.image_url.startsWith('data:video'));
            
            // Get likes and saved status for this post
            let likesCount = 0;
            let isLiked = false;
            let isSaved = false;
            
            try {
              const { count } = await window.sb
                .from('likes')
                .select('*', { count: 'exact', head: true })
                .eq('post_id', post.id);
              likesCount = count || 0;
              
              if (window.currentUser) {
                const { data: userLike } = await window.sb
                  .from('likes')
                  .select('id')
                  .eq('post_id', post.id)
                  .eq('user_id', window.currentUser.id)
                  .maybeSingle();
                isLiked = !!userLike;
                
                const { data: userSave } = await window.sb
                  .from('saved_posts')
                  .select('id')
                  .eq('post_id', post.id)
                  .eq('user_id', window.currentUser.id)
                  .maybeSingle();
                isSaved = !!userSave;
              }
            } catch (err) {
              console.log('Error getting post stats:', err);
            }
            
            html += `
              <div class="post">
                <div class="post-header" style="display: flex; align-items: center; padding: 1rem; gap: 0.75rem;">
                  <div class="post-avatar">
                    ${user?.avatar_url ? 
                      `<img src="${user.avatar_url}" alt="${user.username}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />` : 
                      `<span style="width: 32px; height: 32px; border-radius: 50%; background: #e1306c; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">${user?.username?.[0]?.toUpperCase() || 'U'}</span>`
                    }
                  </div>
                  <div class="post-username" style="flex: 1; color: #ffffff; font-weight: 600; cursor: pointer;" onclick="visitUserProfile('${post.user_id}', '${user?.username || 'User'}')">${user?.username || 'User'}</div>
                  <div class="post-more-container">
                    <button class="post-more" onclick="togglePostMenu(event, '${post.id}', '${post.user_id}', '${user?.username || 'User'}')">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                      </svg>
                    </button>
                    <div class="post-menu" id="postMenu-${post.id}">
                      <button class="post-menu-item" onclick="visitUserProfile('${post.user_id}', '${user?.username || 'User'}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        Visit Profile
                      </button>
                      <button class="post-menu-item" onclick="startDirectMessage('${post.user_id}', '${user?.username || 'User'}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                        </svg>
                        Message
                      </button>
                      <button class="post-menu-item" onclick="followUserFromPost('${post.user_id}', '${user?.username || 'User'}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        Follow
                      </button>
                      ${post.user_id === window.currentUser?.id ? `
                        <button class="post-menu-item" onclick="deletePost('${post.id}')" style="color: #ff4757;">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                          </svg>
                          Delete
                        </button>
                      ` : ''}
                    </div>
                  </div>
                </div>
                
                ${post.image_url ? (isVideo ? 
                  `<video src="${post.image_url}" controls class="post-image" style="width: 100%; max-height: 600px; object-fit: cover;" />` :
                  `<img src="${post.image_url}" alt="Post" class="post-image" style="width: 100%; max-height: 600px; object-fit: cover;" />`
                ) : ''}
                
                <div class="post-actions">
                  <div class="post-actions-left">
                    <button class="post-action like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')" data-post-id="${post.id}" title="Like">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="${isLiked ? '#ff3040' : 'none'}" stroke="${isLiked ? '#ff3040' : '#ffffff'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                      </svg>
                    </button>
                    <button class="post-action" onclick="showComments('${post.id}')" title="Comment">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                      </svg>
                    </button>
                    <button class="post-action" onclick="showShareModal('${post.id}')" title="Share">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                        <polyline points="16,6 12,2 8,6"/>
                        <line x1="12" y1="2" x2="12" y2="15"/>
                      </svg>
                    </button>
                  </div>
                  <div class="post-actions-right">
                    <button class="post-action save-btn ${isSaved ? 'saved' : ''}" onclick="toggleSave('${post.id}')" data-post-id="${post.id}" title="Save">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="${isSaved ? '#ffd700' : 'none'}" stroke="${isSaved ? '#ffd700' : '#ffffff'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <div class="post-stats">
                  <div class="post-likes" id="likes-${post.id}" onclick="showLikes('${post.id}')">${likesCount} ${likesCount === 1 ? 'like' : 'likes'}</div>
                </div>
                
                ${post.caption ? `<div class="post-caption"><strong>${user?.username || 'User'}</strong> ${post.caption}</div>` : ''}
                <div class="post-timestamp">${formatTime(post.created_at)}</div>
              </div>
            `;
          }
        } else {
          html = '<div class="no-content">No posts yet. Create your first post!</div>';
        }
        
        feedContainer.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading feed:', error);
        const feedContainer = document.getElementById('feed');
        if (feedContainer) {
          feedContainer.innerHTML = '<div class="no-content">Error loading posts. Please try again.</div>';
        }
      }
    }

    // Search users
    async function searchUsers(query) {
      const { data: users } = await window.sb
        .from('profiles')
        .select('*')
        .ilike('username', `%${query}%`)
        .eq('is_disabled', false)
        .limit(20);
      
      // Load fresh presence data
      await loadPresenceData();
      
      const container = document.getElementById('searchResults');
      const chatContainer = document.getElementById('chatSearchResults');
      let html = '';
      
      if (users?.length) {
        users.forEach(user => {
          if (user.id !== window.currentUser?.id) {
            const presence = window.userPresence.get(user.id);
            const isOnline = presence?.online || false;
            const lastSeenText = presence?.lastSeen ? formatTime(presence.lastSeen) : 'Unknown';
            
            const userHtml = `
              <div class="user-item" onclick="addToRecentSearches('${user.id}', '${user.username}'); openChat('${user.id}', '${user.username}'); showSection('messages');">
                <div style="position: relative; margin-right: 12px;">
                  <div class="chat-avatar" style="width: 40px; height: 40px;">
                    ${user.avatar_url ? 
                      `<img src="${user.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />` : 
                      `<span style="width: 100%; height: 100%; border-radius: 50%; background: #e1306c; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">${user.username[0].toUpperCase()}</span>`
                    }
                  </div>
                  <div class="presence-indicator" style="position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${isOnline ? '#4CAF50' : '#8e8e8e'}; border: 2px solid var(--bg-dark);" title="${isOnline ? 'Online' : `Last seen ${lastSeenText}`}"></div>
                </div>
                <div class="user-info">
                  <div class="user-name">${user.username}</div>
                  ${user.full_name ? `<div style="color: #8e8e8e; font-size: 0.9rem;">${user.full_name}</div>` : ''}
                  <div style="font-size: 12px; color: ${isOnline ? '#4CAF50' : '#8e8e8e'};">${isOnline ? 'Online' : `Last seen ${lastSeenText}`}</div>
                </div>
              </div>
            `;
            html += userHtml;
          }
        });
      } else {
        html = '<div class="no-results">No users found</div>';
      }
      
      if (container) container.innerHTML = html;
      if (chatContainer) {
        chatContainer.innerHTML = html;
        chatContainer.classList.remove('hidden');
      }
    }

    // Add to recent searches
    function addToRecentSearches(userId, username) {
      let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
      
      // Remove if already exists
      recentSearches = recentSearches.filter(search => search.userId !== userId);
      
      // Add to beginning
      recentSearches.unshift({ userId, username, timestamp: Date.now() });
      
      // Keep only last 10
      recentSearches = recentSearches.slice(0, 10);
      
      localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
      loadRecentSearches();
    }

    // Load recent searches
    function loadRecentSearches() {
      const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
      const container = document.getElementById('recentSearches');
      
      if (!container) return;
      
      let html = '';
      
      if (recentSearches.length) {
        recentSearches.forEach(search => {
          html += `
            <div class="user-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
              <div style="display: flex; align-items: center; flex: 1;" onclick="openChat('${search.userId}', '${search.username}'); showSection('messages');">
                <div class="chat-avatar" style="width: 40px; height: 40px; margin-right: 12px;">
                  <span style="width: 100%; height: 100%; border-radius: 50%; background: #e1306c; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">${search.username[0].toUpperCase()}</span>
                </div>
                <div class="user-info">
                  <div class="user-name">${search.username}</div>
                </div>
              </div>
              <button onclick="removeFromRecentSearches('${search.userId}'); event.stopPropagation();" style="background: none; border: none; color: #8e8e8e; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='#ffffff';" onmouseout="this.style.background='none'; this.style.color='#8e8e8e';" title="Remove">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          `;
        });
      } else {
        html = '<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No recent searches</div>';
      }
      
      container.innerHTML = html;
    }

    // Remove from recent searches
    function removeFromRecentSearches(userId) {
      let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
      recentSearches = recentSearches.filter(search => search.userId !== userId);
      localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
      loadRecentSearches();
    }

    // Load user posts for profile
    async function loadUserPosts(userId = null) {
      const targetUserId = userId || window.currentUser?.id;
      if (!targetUserId) return;
      
      try {
        const { data: posts, error } = await window.sb
          .from('posts')
          .select('*')
          .eq('user_id', targetUserId)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('postsContent') || document.getElementById('userPostsContent');
        if (!container) {
          console.error('Posts container not found');
          return;
        }
        let html = '';
        
        if (posts?.length) {
          html = '<div class="posts-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px;">';
          posts.forEach(post => {
            const isVideo = post.image_url && (post.image_url.includes('video') || post.image_url.startsWith('data:video'));
            html += `
              <div class="post-item" style="aspect-ratio: 1; background: #333; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative;">
                ${post.image_url ? (isVideo ? 
                  `<video src="${post.image_url}" style="width: 100%; height: 100%; object-fit: cover;" muted />` :
                  `<img src="${post.image_url}" alt="Post" style="width: 100%; height: 100%; object-fit: cover;" />`
                ) : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff;">üìù</div>'}
                <div class="post-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;">
                  <span style="color: white; font-weight: 600;">‚ù§Ô∏è 0 üí¨ 0</span>
                </div>
              </div>
            `;
          });
          html += '</div>';
        } else {
          html = '<div class="no-content" style="text-align: center; padding: 2rem; color: #8e8e8e;">No posts yet</div>';
        }
        
        container.innerHTML = html;
        
        // Add hover effects
        container.querySelectorAll('.post-item').forEach(item => {
          item.addEventListener('mouseenter', () => {
            const overlay = item.querySelector('.post-overlay');
            if (overlay) overlay.style.opacity = '1';
          });
          item.addEventListener('mouseleave', () => {
            const overlay = item.querySelector('.post-overlay');
            if (overlay) overlay.style.opacity = '0';
          });
        });
        
      } catch (error) {
        console.error('Error loading posts:', error);
      }
    }
    
    // Load user reels for profile
    async function loadUserReels(userId = null) {
      const targetUserId = userId || window.currentUser?.id;
      if (!targetUserId) return;
      
      try {
        const { data: reels, error } = await window.sb
          .from('posts')
          .select('*')
          .eq('user_id', targetUserId)
          .not('image_url', 'is', null)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        // Get user profile for avatar
        const { data: profile } = await window.sb
          .from('profiles')
          .select('username, avatar_url')
          .eq('id', targetUserId)
          .single();
        
        const container = document.getElementById('reelsContent') || document.getElementById('userReelsContent');
        if (!container) {
          console.error('Reels container not found');
          return;
        }
        let html = '';
        
        if (reels?.length) {
          // Filter for video content (reels)
          const videoReels = reels.filter(reel => 
            reel.image_url && (reel.image_url.includes('video') || reel.image_url.startsWith('data:video'))
          );
          
          if (videoReels.length > 0) {
            html = '<div class="reels-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px;">';
            videoReels.forEach(reel => {
              html += `
                <div class="reel-item" onclick="openContentPopup('${reel.id}', 'reel')" style="aspect-ratio: 9/16; background: #333; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative;">
                  <video src="${reel.image_url}" style="width: 100%; height: 100%; object-fit: cover;" muted />
                  <div class="reel-cover-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(transparent 60%, rgba(0,0,0,0.8)); display: flex; flex-direction: column; justify-content: space-between; padding: 8px;">
                    <div class="reel-avatar" style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                      ${profile?.avatar_url ? 
                        `<img src="${profile.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;" />` : 
                        `${profile?.username?.[0]?.toUpperCase() || 'U'}`
                      }
                    </div>
                    <div class="reel-play-icon" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.2s;">
                      <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                        <path d="M8 5v14l11-7z"/>
                      </svg>
                    </div>
                  </div>
                </div>
              `;
            });
            html += '</div>';
          } else {
            html = '<div class="no-content" style="text-align: center; padding: 2rem; color: #8e8e8e;">No reels yet</div>';
          }
        } else {
          html = '<div class="no-content" style="text-align: center; padding: 2rem; color: #8e8e8e;">No reels yet</div>';
        }
        
        container.innerHTML = html;
        
        // Add hover effects
        container.querySelectorAll('.reel-item').forEach(item => {
          item.addEventListener('mouseenter', () => {
            const playIcon = item.querySelector('.reel-play-icon');
            if (playIcon) playIcon.style.opacity = '1';
          });
          item.addEventListener('mouseleave', () => {
            const playIcon = item.querySelector('.reel-play-icon');
            if (playIcon) playIcon.style.opacity = '0';
          });
        });
        
      } catch (error) {
        console.error('Error loading reels:', error);
      }
    }
    
    // Edit profile function
    function editProfile() {
      if (!window.currentUser) {
        alert('Please log in to edit profile');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-dialog">
          <div class="modal-header">
            <h3>Edit Profile</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <form class="modal-form" onsubmit="saveProfile(event)">
            <label>Username
              <input type="text" id="editUsername" value="${window.currentUser.profile?.username || ''}" required />
            </label>
            <label>Full Name
              <input type="text" id="editFullName" value="${window.currentUser.profile?.full_name || ''}" />
            </label>
            <label>Bio
              <textarea id="editBio" rows="3" placeholder="Tell us about yourself...">${window.currentUser.profile?.bio || ''}</textarea>
            </label>
            <label>Profile Picture
              <button type="button" id="btnPickAvatar" class="upload-btn">Choose Photo</button>
              <input type="file" id="avatarFile" accept="image/*" style="display: none;" />
              <div id="avatarPreview" style="margin-top: 8px;"></div>
            </label>
            <label>Or Avatar URL
              <input type="url" id="editAvatarUrl" value="${window.currentUser.profile?.avatar_url || ''}" placeholder="https://example.com/avatar.jpg" />
            </label>
            <div class="modal-actions">
              <button type="button" onclick="this.closest('.modal').remove()" class="cancel-btn">Cancel</button>
              <button type="submit" class="save-btn">Save Changes</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Save profile function
    async function saveProfile(event) {
      event.preventDefault();
      
      const username = document.getElementById('editUsername').value.trim();
      const fullName = document.getElementById('editFullName').value.trim();
      const bio = document.getElementById('editBio').value.trim();
      const avatarFile = document.getElementById('avatarFile').files[0];
      let avatarUrl = document.getElementById('editAvatarUrl').value.trim();
      
      if (!username) {
        alert('Username is required');
        return;
      }
      
      try {
        // Handle file upload if a file is selected
        if (avatarFile) {
          const reader = new FileReader();
          avatarUrl = await new Promise((resolve) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(avatarFile);
          });
        }
        
        const { error } = await window.sb
          .from('profiles')
          .update({
            username: username,
            full_name: fullName || null,
            bio: bio || null,
            avatar_url: avatarUrl || null
          })
          .eq('id', window.currentUser.id);
        
        if (error) throw error;
        
        // Update current user profile
        window.currentUser.profile = {
          ...window.currentUser.profile,
          username: username,
          full_name: fullName,
          bio: bio,
          avatar_url: avatarUrl
        };
        
        // Close modal
        document.querySelector('.modal').remove();
        
        // Refresh profile display
        loadProfileInfo();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = 'Profile updated successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
      }
    }

    // Show profile tab
    function showProfileTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
      
      // Show content
      document.querySelectorAll('.profile-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${tabName}Content`)?.classList.remove('hidden');
      
      // Load content based on tab
      if (tabName === 'posts') {
        loadUserPosts(window.currentUser?.id);
      } else if (tabName === 'reels') {
        loadUserReels(window.currentUser?.id);
      }
    }

    // Show section
    function showSection(section) {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      const sectionEl = document.getElementById(section + 'Section');
      if (sectionEl) {
        sectionEl.classList.add('active');
      }
      
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-section="${section}"]`).classList.add('active');
      
      // Update section title
      const titles = {
        'home': 'Home',
        'search': 'Search',
        'reels': 'Reels',
        'messages': 'Messages',
        'profile': 'Profile',
        'create': 'Create',
        'notifications': 'Activity'
      };
      document.getElementById('sectionTitle').textContent = titles[section] || 'Home';
      
      if (section === 'search') {
        const searchInput = document.getElementById('searchQuery');
        if (searchInput) searchInput.focus();
        loadRecentSearches();
      } else if (section === 'profile') {
        loadProfileInfo();
        setTimeout(() => {
          showProfileTab('posts');
        }, 100);
      } else if (section === 'messages') {
        if (!checkChatLock()) {
          showSection('home');
          return;
        }
      } else if (section === 'reels') {
        loadReelsFeed();
      }
    }
    
    // Go to home function
    function goToHome() {
      showSection('home');
    }

    // Logout
    async function logout() {
      // Mark user as offline before logout
      if (window.currentUser) {
        await updateUserPresence(false);
      }
      
      // Clean up subscriptions
      if (window.messageSubscription) {
        window.messageSubscription.unsubscribe();
        window.messageSubscription = null;
      }
      
      if (window.presenceSubscription) {
        window.presenceSubscription.unsubscribe();
        window.presenceSubscription = null;
      }
      
      // Clear presence data
      window.userPresence.clear();
      
      await window.sb.auth.signOut();
      window.location.href = 'auth.html';
    }

    // Post interaction functions
    async function toggleLike(postId) {
      if (!window.currentUser) {
        alert('Please log in to like posts');
        return;
      }
      
      const likeBtn = document.querySelector(`[data-post-id="${postId}"].like-btn`);
      const likesEl = document.getElementById(`likes-${postId}`);
      
      try {
        const { data: existingLike } = await window.sb
          .from('likes')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', window.currentUser.id)
          .maybeSingle();
        
        if (existingLike) {
          await window.sb
            .from('likes')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', window.currentUser.id);
          
          likeBtn.classList.remove('liked');
          likeBtn.querySelector('svg').setAttribute('fill', 'none');
          likeBtn.querySelector('svg').setAttribute('stroke', '#ffffff');
        } else {
          await window.sb
            .from('likes')
            .insert({
              post_id: postId,
              user_id: window.currentUser.id
            });
          
          likeBtn.classList.add('liked');
          likeBtn.querySelector('svg').setAttribute('fill', '#ff3040');
          likeBtn.querySelector('svg').setAttribute('stroke', '#ff3040');
        }
        
        const { count } = await window.sb
          .from('likes')
          .select('*', { count: 'exact', head: true })
          .eq('post_id', postId);
        
        if (likesEl) {
          likesEl.textContent = `${count || 0} ${count === 1 ? 'like' : 'likes'}`;
        }
        
      } catch (error) {
        console.error('Error toggling like:', error);
      }
    }
    
    async function toggleSave(postId) {
      if (!window.currentUser) {
        alert('Please log in to save posts');
        return;
      }
      
      const saveBtn = document.querySelector(`[data-post-id="${postId}"].save-btn`);
      
      try {
        const { data: existingSave } = await window.sb
          .from('saved_posts')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', window.currentUser.id)
          .maybeSingle();
        
        if (existingSave) {
          await window.sb
            .from('saved_posts')
            .delete()
            .eq('post_id', postId)
            .eq('user_id', window.currentUser.id);
          
          saveBtn.classList.remove('saved');
          saveBtn.querySelector('svg').setAttribute('fill', 'none');
          saveBtn.querySelector('svg').setAttribute('stroke', '#ffffff');
        } else {
          await window.sb
            .from('saved_posts')
            .insert({
              post_id: postId,
              user_id: window.currentUser.id
            });
          
          saveBtn.classList.add('saved');
          saveBtn.querySelector('svg').setAttribute('fill', '#ffd700');
          saveBtn.querySelector('svg').setAttribute('stroke', '#ffd700');
        }
        
      } catch (error) {
        console.error('Error toggling save:', error);
      }
    }
    
    async function showComments(postId) {
      try {
        const { data: comments, error } = await window.sb
          .from('comments')
          .select('*')
          .eq('post_id', postId)
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        const modal = document.createElement('div');
        modal.id = 'commentsModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-backdrop" onclick="closeCommentsModal()"></div>
          <div class="modal-dialog">
            <div class="modal-header">
              <h3>Comments</h3>
              <button onclick="closeCommentsModal()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
              <div class="comments-list" id="commentsList">
                ${comments?.map(comment => `
                  <div class="comment-item">
                    <div class="comment-content">
                      <div class="comment-text">${comment.content}</div>
                      <div class="comment-time">${formatTime(comment.created_at)}</div>
                    </div>
                  </div>
                `).join('') || '<div class="no-content">No comments yet</div>'}
              </div>
              <form class="comment-form" onsubmit="addComment(event, '${postId}')">
                <input type="text" placeholder="Add a comment..." required />
                <button type="submit">Post</button>
              </form>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
      } catch (error) {
        console.error('Error loading comments:', error);
        alert('Failed to load comments. Please try again.');
      }
    }
    
    function closeCommentsModal() {
      const modal = document.getElementById('commentsModal');
      if (modal) modal.remove();
    }
    
    async function addComment(event, postId) {
      event.preventDefault();
      
      if (!window.currentUser) {
        alert('Please log in to comment');
        return;
      }
      
      const form = event.target;
      const input = form.querySelector('input');
      const content = input.value.trim();
      
      if (!content) return;
      
      try {
        const { error } = await window.sb
          .from('comments')
          .insert({
            post_id: postId,
            user_id: window.currentUser.id,
            content: content
          });
        
        if (error) throw error;
        
        input.value = '';
        closeCommentsModal();
        showComments(postId);
        
      } catch (error) {
        console.error('Error adding comment:', error);
        alert('Failed to add comment. Please try again.');
      }
    }
    
    async function sharePost(postId) {
      const modal = document.createElement('div');
      modal.id = 'shareModal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="closeShareModal()"></div>
        <div class="modal-dialog share-modal">
          <div class="modal-header">
            <h3>Share</h3>
            <button onclick="closeShareModal()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body">
            <div class="share-options">
              <div class="share-option" onclick="copyPostLink('${postId}')">
                <div class="share-icon">üîó</div>
                <span>Copy Link</span>
              </div>
              <div class="share-option" onclick="shareToWhatsApp('${postId}')">
                <div class="share-icon">üì±</div>
                <span>WhatsApp</span>
              </div>
              <div class="share-option" onclick="downloadContent('${postId}')">
                <div class="share-icon">üíæ</div>
                <span>Download</span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    function closeShareModal() {
      const modal = document.getElementById('shareModal');
      if (modal) modal.remove();
    }
    
    function copyPostLink(postId) {
      const postUrl = `${window.location.origin}${window.location.pathname}#post-${postId}`;
      navigator.clipboard.writeText(postUrl).then(() => {
        alert('Link copied to clipboard!');
      }).catch(() => {
        alert('Please copy this link manually: ' + postUrl);
      });
      closeShareModal();
    }
    
    function shareToWhatsApp(postId) {
      const postUrl = `${window.location.origin}${window.location.pathname}#post-${postId}`;
      const text = encodeURIComponent(`Check out this post: ${postUrl}`);
      const whatsappUrl = `https://wa.me/?text=${text}`;
      window.open(whatsappUrl, '_blank');
      closeShareModal();
    }
    
    function showLikes(postId) {
      // Show likes modal - simplified version
      alert('Likes feature - coming soon!');
    }
    
    // Chat lock functions
    function setupChatLock() {
      const password = prompt('Set a password for chat lock:');
      if (password && password.length >= 4) {
        localStorage.setItem('chatLockPassword', btoa(password));
        localStorage.setItem('chatLockEnabled', 'true');
        alert('Chat lock enabled! You will need to enter this password to access messages.');
      } else if (password) {
        alert('Password must be at least 4 characters long');
      }
    }
    
    function checkChatLock() {
      const isEnabled = localStorage.getItem('chatLockEnabled') === 'true';
      const storedPassword = localStorage.getItem('chatLockPassword');
      
      if (isEnabled && storedPassword) {
        const enteredPassword = prompt('Enter chat lock password:');
        if (!enteredPassword || btoa(enteredPassword) !== storedPassword) {
          alert('Incorrect password!');
          return false;
        }
      }
      return true;
    }
    
    // Hide chat functions
    function setupHideChat() {
      const password = prompt('Set a password for hide chat:');
      if (password && password.length >= 4) {
        localStorage.setItem('hideChatPassword', btoa(password));
        localStorage.setItem('hideChatEnabled', 'true');
        alert('Hide chat enabled! You can now hide chats from the main list.');
      } else if (password) {
        alert('Password must be at least 4 characters long');
      }
    }
    
    function checkHideChatPassword() {
      const storedPassword = localStorage.getItem('hideChatPassword');
      if (!storedPassword) {
        alert('Please set up hide chat password first in settings.');
        return false;
      }
      
      const enteredPassword = prompt('Enter hide chat password:');
      if (!enteredPassword || btoa(enteredPassword) !== storedPassword) {
        alert('Incorrect password!');
        return false;
      }
      return true;
    }
    
    function hideCurrentChat() {
      if (!window.currentChat) {
        alert('No active chat to hide');
        return;
      }
      
      if (!checkHideChatPassword()) return;
      
      const hiddenChats = JSON.parse(localStorage.getItem('hiddenChats') || '[]');
      if (!hiddenChats.includes(window.currentChat.partnerId)) {
        hiddenChats.push(window.currentChat.partnerId);
        localStorage.setItem('hiddenChats', JSON.stringify(hiddenChats));
        
        alert(`Chat with ${window.currentChat.partnerName} has been hidden`);
        
        // Go back to chats list
        document.getElementById('chatArea').classList.add('hidden');
        document.getElementById('chatsList').style.display = 'block';
        document.getElementById('chatSearchContainer').style.display = 'block';
        window.currentChat = null;
        
        // Refresh chats to remove hidden chat
        loadChats();
      } else {
        alert('This chat is already hidden');
      }
    }
    
    function showHiddenChats() {
      if (!checkHideChatPassword()) return;
      
      const hiddenChats = JSON.parse(localStorage.getItem('hiddenChats') || '[]');
      
      if (hiddenChats.length === 0) {
        alert('No hidden chats found');
        return;
      }
      
      showHiddenChatsModal(hiddenChats);
    }
    
    async function showHiddenChatsModal(hiddenChatIds) {
      const hiddenChatsWithProfiles = [];
      
      for (const userId of hiddenChatIds) {
        const { data: profile } = await window.sb
          .from('profiles')
          .select('username, avatar_url')
          .eq('id', userId)
          .single();
        
        if (profile) {
          hiddenChatsWithProfiles.push({
            userId: userId,
            profile: profile
          });
        }
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-dialog">
          <div class="modal-header">
            <h3>Hidden Chats</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body">
            ${hiddenChatsWithProfiles.length ? hiddenChatsWithProfiles.map(chat => `
              <div class="user-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 12px;" onclick="openChat('${chat.userId}', '${chat.profile.username}'); this.closest('.modal').remove(); showSection('messages');">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; cursor: pointer;">
                    ${chat.profile.avatar_url ? 
                      `<img src="${chat.profile.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />` : 
                      `${chat.profile.username[0].toUpperCase()}`
                    }
                  </div>
                  <div style="cursor: pointer;">
                    <div style="color: #ffffff; font-weight: 600;">${chat.profile.username}</div>
                    <div style="color: #8e8e8e; font-size: 12px;">Hidden chat</div>
                  </div>
                </div>
                <button onclick="unhideChat('${chat.userId}', '${chat.profile.username}')" style="padding: 6px 12px; background: #0095f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                  Unhide
                </button>
              </div>
            `).join('') : '<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No hidden chats</div>'}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Update chat lock toggle status
    function updateChatLockToggle() {
      const toggle = document.getElementById('chatLockToggle');
      const isEnabled = localStorage.getItem('chatLockEnabled') === 'true';
      
      if (toggle) {
        if (isEnabled) {
          toggle.textContent = 'ON';
          toggle.style.background = '#4CAF50';
          toggle.style.color = 'white';
        } else {
          toggle.textContent = 'OFF';
          toggle.style.background = '#333';
          toggle.style.color = '#8e8e8e';
        }
      }
    }
    
    // Toggle chat lock
    function toggleChatLock() {
      const isEnabled = localStorage.getItem('chatLockEnabled') === 'true';
      
      if (isEnabled) {
        const storedPassword = localStorage.getItem('chatLockPassword');
        const enteredPassword = prompt('Enter current chat lock password to disable:');
        
        if (!enteredPassword || btoa(enteredPassword) !== storedPassword) {
          alert('Incorrect password! Chat lock remains enabled.');
          return;
        }
        
        localStorage.removeItem('chatLockEnabled');
        localStorage.removeItem('chatLockPassword');
        alert('Chat lock disabled');
      } else {
        setupChatLock();
      }
      
      updateChatLockToggle();
    }
    
    // View hidden chats with password
    async function viewHiddenChats() {
      if (!checkHideChatPassword()) return;
      
      await loadHiddenChatsInSettings();
    }
    
    // Load hidden chats in settings
    async function loadHiddenChatsInSettings() {
      const hiddenChats = JSON.parse(localStorage.getItem('hiddenChats') || '[]');
      const container = document.getElementById('hiddenChatsList');
      
      if (!container) {
        console.log('Hidden chats container not found');
        return;
      }
      
      if (hiddenChats.length === 0) {
        container.innerHTML = '<div style="color: #8e8e8e; font-size: 14px; text-align: center; padding: 1rem;">No hidden chats</div>';
        return;
      }
      
      container.innerHTML = '<div style="color: #8e8e8e; font-size: 14px; text-align: center; padding: 1rem;">Loading...</div>';
      
      let html = '';
      
      try {
        for (const userId of hiddenChats) {
          const { data: profile, error } = await window.sb
            .from('profiles')
            .select('username, avatar_url')
            .eq('id', userId)
            .single();
          
          if (error) {
            console.error('Error loading profile for user:', userId, error);
            continue;
          }
          
          if (profile) {
            html += `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                <div style="display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="openChat('${userId}', '${profile.username}'); document.querySelector('.modal').remove(); showSection('messages');">
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                    ${profile.avatar_url ? 
                      `<img src="${profile.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />` : 
                      `${profile.username[0].toUpperCase()}`
                    }
                  </div>
                  <div style="color: #ffffff; font-size: 14px;">${profile.username}</div>
                </div>
                <button onclick="unhideChat('${userId}', '${profile.username}')" style="padding: 4px 8px; background: #0095f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                  Unhide
                </button>
              </div>
            `;
          }
        }
        
        if (html) {
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div style="color: #8e8e8e; font-size: 14px; text-align: center; padding: 1rem;">No valid hidden chats found</div>';
        }
        
      } catch (error) {
        console.error('Error loading hidden chats:', error);
        container.innerHTML = '<div style="color: #ff4757; font-size: 14px; text-align: center; padding: 1rem;">Error loading hidden chats</div>';
      }
    }
    
    function unhideChat(userId, username) {
      if (!confirm(`Unhide chat with ${username}?`)) return;
      
      const hiddenChats = JSON.parse(localStorage.getItem('hiddenChats') || '[]');
      const updatedHiddenChats = hiddenChats.filter(id => id !== userId);
      localStorage.setItem('hiddenChats', JSON.stringify(updatedHiddenChats));
      
      alert(`Chat with ${username} has been unhidden`);
      
      loadHiddenChatsInSettings();
      loadChats();
    }
    
    // Chat themes data
    const chatThemes = [
      { name: 'Default', background: 'var(--bg-dark)' },
      { name: 'Ocean Waves', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
      { name: 'Sunset', background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
      { name: 'Forest', background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
      { name: 'Purple Dream', background: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' },
      { name: 'Fire', background: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)' },
      { name: 'Night Sky', background: 'linear-gradient(135deg, #0c3483 0%, #a2b6df 100%)' },
      { name: 'Cherry Blossom', background: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
      { name: 'Mint', background: 'linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%)' },
      { name: 'Galaxy', background: 'linear-gradient(135deg, #2c3e50 0%, #4a6741 100%)' },
      { name: 'Rose Gold', background: 'linear-gradient(135deg, #f7971e 0%, #ffd200 100%)' },
      { name: 'Arctic', background: 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)' },
      { name: 'Lavender', background: 'linear-gradient(135deg, #e17055 0%, #f39c12 100%)' },
      { name: 'Emerald', background: 'linear-gradient(135deg, #00b894 0%, #00cec9 100%)' },
      { name: 'Coral', background: 'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)' },
      { name: 'Midnight', background: 'linear-gradient(135deg, #2d3436 0%, #636e72 100%)' },
      { name: 'Peachy', background: 'linear-gradient(135deg, #fab1a0 0%, #e17055 100%)' },
      { name: 'Sky Blue', background: 'linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%)' },
      { name: 'Golden Hour', background: 'linear-gradient(135deg, #fdcb6e 0%, #e84393 100%)' },
      { name: 'Deep Sea', background: 'linear-gradient(135deg, #00cec9 0%, #55a3ff 100%)' },
      { name: 'Autumn', background: 'linear-gradient(135deg, #fd79a8 0%, #ff7675 100%)' },
      { name: 'Spring', background: 'linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%)' },
      { name: 'Tropical', background: 'linear-gradient(135deg, #00b894 0%, #55efc4 100%)' },
      { name: 'Cosmic', background: 'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)' },
      { name: 'Warm Sunset', background: 'linear-gradient(135deg, #ff7675 0%, #fd79a8 100%)' }
    ];
    
    // Show chat themes modal
    function showChatThemes() {
      const currentTheme = localStorage.getItem('chatTheme') || 'Default';
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-dialog" style="max-width: 600px;">
          <div class="modal-header">
            <h3>Chat Themes</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body" style="padding: 1rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto;">
              ${chatThemes.map(theme => `
                <div class="theme-option" onclick="applyChatTheme('${theme.name}', '${theme.background}')" style="
                  background: ${theme.background};
                  height: 80px;
                  border-radius: 12px;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-weight: 600;
                  font-size: 12px;
                  text-align: center;
                  border: ${currentTheme === theme.name ? '3px solid #0095f6' : '2px solid rgba(255,255,255,0.2)'};
                  transition: all 0.2s ease;
                  position: relative;
                  overflow: hidden;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                  <div style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; backdrop-filter: blur(5px);">
                    ${theme.name}
                  </div>
                  ${currentTheme === theme.name ? '<div style="position: absolute; top: 4px; right: 4px; color: #0095f6; font-size: 16px;">‚úì</div>' : ''}
                </div>
              `).join('')}
            </div>
            <div style="margin-top: 1rem; text-align: center;">
              <button onclick="resetChatTheme()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">
                Reset to Default
              </button>
              <button onclick="this.closest('.modal').remove()" style="padding: 8px 16px; background: #0095f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Done
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // Apply chat theme
    function applyChatTheme(themeName, themeBackground) {
      localStorage.setItem('chatTheme', themeName);
      localStorage.setItem('chatThemeBackground', themeBackground);
      
      const messagesContainer = document.getElementById('messages');
      if (messagesContainer) {
        messagesContainer.style.background = themeBackground;
      }
      
      // Update theme selection in modal
      document.querySelectorAll('.theme-option').forEach(option => {
        option.style.border = '2px solid rgba(255,255,255,0.2)';
        const checkmark = option.querySelector('div:last-child');
        if (checkmark && checkmark.textContent === '‚úì') {
          checkmark.remove();
        }
      });
      
      event.target.style.border = '3px solid #0095f6';
      const checkmark = document.createElement('div');
      checkmark.style.cssText = 'position: absolute; top: 4px; right: 4px; color: #0095f6; font-size: 16px;';
      checkmark.textContent = '‚úì';
      event.target.appendChild(checkmark);
      
      // Show success message
      const successMsg = document.createElement('div');
      successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
      successMsg.textContent = `${themeName} theme applied!`;
      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 2000);
    }
    
    // Reset chat theme
    function resetChatTheme() {
      localStorage.removeItem('chatTheme');
      localStorage.removeItem('chatThemeBackground');
      
      const messagesContainer = document.getElementById('messages');
      if (messagesContainer) {
        messagesContainer.style.background = 'var(--bg-dark)';
      }
      
      document.querySelector('.modal').remove();
      showChatThemes();
    }
    
    // Load saved theme on chat open
    function loadChatTheme() {
      const savedTheme = localStorage.getItem('chatThemeBackground');
      if (savedTheme) {
        const messagesContainer = document.getElementById('messages');
        if (messagesContainer) {
          messagesContainer.style.background = savedTheme;
        }
      }
    }
    
    // Account disable function
    async function disableAccount() {
      if (!confirm('Are you sure you want to disable your account?')) return;
      
      const password = prompt('Enter your password to confirm:');
      if (!password) return;
      
      try {
        const { error } = await window.sb
          .from('profiles')
          .update({ 
            is_disabled: true,
            disabled_at: new Date().toISOString()
          })
          .eq('id', window.currentUser.id);
        
        if (error) throw error;
        
        alert('Account disabled successfully. You will be logged out.');
        localStorage.clear();
        await window.sb.auth.signOut();
        window.location.href = 'auth.html';
        
      } catch (error) {
        console.error('Error disabling account:', error);
        alert('Failed to disable account: ' + error.message);
      }
    }
    
    // Load profile info
    async function loadProfileInfo() {
      if (!window.currentUser) return;
      
      try {
        const { data: profile } = await window.sb
          .from('profiles')
          .select('*')
          .eq('id', window.currentUser.id)
          .single();
        
        const { count: postsCount } = await window.sb
          .from('posts')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', window.currentUser.id);
        
        const { count: followersCount } = await window.sb
          .from('follows')
          .select('*', { count: 'exact', head: true })
          .eq('followee_id', window.currentUser.id);
        
        const { count: followingCount } = await window.sb
          .from('follows')
          .select('*', { count: 'exact', head: true })
          .eq('follower_id', window.currentUser.id);
        
        if (profile) {
          document.getElementById('profileUsername').textContent = profile.username || 'username';
          document.getElementById('profileFullname').textContent = profile.full_name || '';
          document.getElementById('profileBio').textContent = profile.bio || '';
          
          const avatarEl = document.getElementById('profileAvatar');
          if (profile.avatar_url && profile.avatar_url.trim()) {
            avatarEl.innerHTML = `<img src="${profile.avatar_url}" alt="${profile.username}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" />`;
          } else {
            avatarEl.innerHTML = `<span style="font-size: 3rem; font-weight: 600; color: #ffffff;">${(profile.username || 'U')[0].toUpperCase()}</span>`;
          }
        }
        
        document.getElementById('postsCount').textContent = postsCount || 0;
        document.getElementById('followersCount').textContent = followersCount || 0;
        document.getElementById('followingCount').textContent = followingCount || 0;
        
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }
    
    // Show followers/following
    async function showFollowers() {
      try {
        const { data: follows } = await window.sb
          .from('follows')
          .select('follower_id')
          .eq('followee_id', window.currentUser.id);
        
        const followers = [];
        if (follows?.length) {
          for (const follow of follows) {
            const { data: profile } = await window.sb
              .from('profiles')
              .select('id, username, avatar_url')
              .eq('id', follow.follower_id)
              .single();
            if (profile) followers.push(profile);
          }
        }
        
        showUserListModal('Followers', followers);
      } catch (error) {
        console.error('Error loading followers:', error);
      }
    }
    
    async function showFollowing() {
      try {
        const { data: follows } = await window.sb
          .from('follows')
          .select('followee_id')
          .eq('follower_id', window.currentUser.id);
        
        const following = [];
        if (follows?.length) {
          for (const follow of follows) {
            const { data: profile } = await window.sb
              .from('profiles')
              .select('id, username, avatar_url')
              .eq('id', follow.followee_id)
              .single();
            if (profile) following.push(profile);
          }
        }
        
        showUserListModal('Following', following);
      } catch (error) {
        console.error('Error loading following:', error);
      }
    }
    
    // Toggle user menu
    function toggleUserMenu(event, userId, username, index) {
      event.stopPropagation();
      
      // Close all other menus
      document.querySelectorAll('.post-menu').forEach(menu => {
        if (menu.id !== `userMenu-${index}`) {
          menu.style.display = 'none';
          menu.style.opacity = '0';
          menu.style.transform = 'translateY(-10px)';
        }
      });
      
      const menu = document.getElementById(`userMenu-${index}`);
      if (menu) {
        if (menu.style.display === 'none' || menu.style.display === '') {
          menu.style.display = 'block';
          setTimeout(() => {
            menu.style.opacity = '1';
            menu.style.transform = 'translateY(0)';
          }, 10);
        } else {
          menu.style.opacity = '0';
          menu.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            menu.style.display = 'none';
          }, 300);
        }
      }
    }
    
    // Make toggleUserMenu globally available
    window.toggleUserMenu = toggleUserMenu;
    
    function showUserListModal(title, users) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-dialog">
          <div class="modal-header">
            <h3>${title}</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body">
            ${users.length ? users.map((user, index) => `
              <div class="user-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                    ${user.avatar_url ? `<img src="${user.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />` : user.username[0].toUpperCase()}
                  </div>
                  <div style="color: #ffffff;">${user.username}</div>
                </div>
                <div class="post-more-container" style="position: relative;">
                  <button class="post-more" onclick="toggleUserMenu(event, '${user.id}', '${user.username}', ${index})" style="background: none; border: none; color: #ffffff; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                  </button>
                  <div class="post-menu" id="userMenu-${index}" style="position: absolute; top: 100%; right: 0; background: rgba(20, 20, 30, 0.98); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; min-width: 180px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); z-index: 1000; display: none; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; overflow: hidden;">
                    <button class="post-menu-item" onclick="visitUserProfile('${user.id}', '${user.username}'); this.closest('.modal').remove();" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 18px; background: none; border: none; color: #ffffff; text-align: left; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; font-weight: 500;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                      </svg>
                      Visit Profile
                    </button>
                    <button class="post-menu-item" onclick="startDirectMessage('${user.id}', '${user.username}'); this.closest('.modal').remove();" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 18px; background: none; border: none; color: #ffffff; text-align: left; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; font-weight: 500;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                      </svg>
                      Message
                    </button>
                    <button class="post-menu-item" onclick="followUserFromPost('${user.id}', '${user.username}'); this.closest('.modal').remove();" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 18px; background: none; border: none; color: #ffffff; text-align: left; cursor: pointer; transition: all 0.2s ease; font-size: 0.95rem; font-weight: 500;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                      </svg>
                      Follow
                    </button>
                  </div>
                </div>
              </div>
            `).join('') : '<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No users found</div>'}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Modal functions
    function openCreatePostModal() {
      document.getElementById('createPostModal').classList.remove('hidden');
    }

    function openCreateReelModal() {
      document.getElementById('createReelModal').classList.remove('hidden');
    }

    // Handle post creation
    async function handleCreatePost(event) {
      event.preventDefault();
      
      if (!window.currentUser) {
        alert('Please log in to create posts');
        return;
      }
      
      const form = event.target;
      const fileInput = document.getElementById('postImage');
      const caption = document.getElementById('postCaption').value.trim();
      const audience = document.getElementById('postAudience').value;
      
      if (!fileInput.files[0] && !caption) {
        alert('Please add an image or caption');
        return;
      }
      
      const submitBtn = document.getElementById('postSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sharing...';
      
      try {
        let imageUrl = null;
        
        if (fileInput.files[0]) {
          const file = fileInput.files[0];
          const reader = new FileReader();
          
          imageUrl = await new Promise((resolve) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
          });
        }
        
        const { error } = await window.sb
          .from('posts')
          .insert({
            user_id: window.currentUser.id,
            caption: caption || null,
            image_url: imageUrl,
            audience: audience
          });
        
        if (error) throw error;
        
        // Close modal and reset form
        document.getElementById('createPostModal').classList.add('hidden');
        form.reset();
        document.getElementById('postPreview').innerHTML = '';
        document.getElementById('mediaSelected').textContent = '';
        
        // Switch to home section and refresh feed
        showSection('home');
        await loadFeed();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = 'Post shared successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error creating post:', error);
        alert('Failed to create post. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Share';
      }
    }

    // Handle reel creation
    async function handleCreateReel(event) {
      event.preventDefault();
      
      if (!window.currentUser) {
        alert('Please log in to create reels');
        return;
      }
      
      const form = event.target;
      const fileInput = document.getElementById('reelVideo');
      const caption = document.getElementById('reelCaption').value.trim();
      const audience = document.getElementById('reelAudience').value;
      
      if (!fileInput.files[0]) {
        alert('Please select a video file');
        return;
      }
      
      const submitBtn = document.getElementById('reelSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sharing...';
      
      try {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        const videoUrl = await new Promise((resolve) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(file);
        });
        
        const { error } = await window.sb
          .from('posts')
          .insert({
            user_id: window.currentUser.id,
            caption: caption || null,
            image_url: videoUrl,
            audience: audience
          });
        
        if (error) throw error;
        
        // Close modal and reset form
        document.getElementById('createReelModal').classList.add('hidden');
        form.reset();
        document.getElementById('reelPreview').innerHTML = '';
        document.getElementById('reelVideoSelected').textContent = '';
        
        // Switch to home section and refresh feed
        showSection('home');
        await loadFeed();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = 'Reel shared successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error creating reel:', error);
        alert('Failed to share reel. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Share Reel';
      }
    }

    // Check authentication
    async function checkAuth() {
      try {
        if (!window.sb) {
          console.error('Supabase not available');
          showError('Supabase connection failed. Please refresh the page.');
          return;
        }
        
        const { data: { session }, error } = await window.sb.auth.getSession();
        
        if (error) {
          console.error('Session check error:', error);
          window.location.href = 'auth.html';
          return;
        }
        
        if (!session?.user) {
          console.log('No active session, redirecting to auth');
          window.location.href = 'auth.html';
          return;
        }
        
        window.currentUser = session.user;
        
        // Get user profile
        const { data: profile } = await window.sb
          .from('profiles')
          .select('*')
          .eq('id', session.user.id)
          .maybeSingle();
        
        if (profile) {
          window.currentUser.profile = profile;
        } else {
          // Create profile if doesn't exist
          const username = session.user.email.split('@')[0] + '_' + Math.random().toString(36).substr(2, 4);
          const { data: newProfile } = await window.sb
            .from('profiles')
            .insert({
              id: session.user.id,
              username: username,
              full_name: session.user.user_metadata?.full_name || '',
              avatar_url: session.user.user_metadata?.avatar_url || ''
            })
            .select()
            .single();
          
          if (newProfile) {
            window.currentUser.profile = newProfile;
          }
        }
        
        // Show app UI
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('appPanel').classList.remove('hidden');
        
        // Load initial data
        loadFeed();
        loadChats();
        loadProfileInfo();
        
        // Setup real-time chat list updates
        setupChatListSubscription();
        
        // Setup presence tracking
        setupPresenceTracking();
        
      } catch (error) {
        console.error('Auth check failed:', error);
        showError('Authentication failed. Please try refreshing the page.');
      }
    }
    
    // Show error message
    function showError(message) {
      document.getElementById('loadingScreen').style.display = 'none';
      document.body.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: white; background: #000; font-family: Arial; text-align: center;">
          <div>
            <h2>Error</h2>
            <p>${message}</p>
            <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px; background: #0095f6; color: white; border: none; border-radius: 5px; cursor: pointer;">Refresh Page</button>
          </div>
        </div>
      `;
    }

    // Show saved posts
    async function showSavedPosts() {
      if (!window.currentUser) {
        alert('Please log in to view saved posts');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-dialog" style="max-width: 600px;">
          <div class="modal-header">
            <h3>Saved Posts</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body" style="padding: 1rem;">
            <div class="saved-tabs" style="display: flex; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem;">
              <button class="saved-tab active" onclick="showSavedTab('all')" id="allSavedTab" style="padding: 1rem 2rem; background: none; border: none; color: #ffffff; cursor: pointer; border-bottom: 2px solid #ffffff;">All</button>
              <button class="saved-tab" onclick="showSavedTab('posts')" id="postsSavedTab" style="padding: 1rem 2rem; background: none; border: none; color: #8e8e8e; cursor: pointer; border-bottom: 2px solid transparent;">Posts</button>
              <button class="saved-tab" onclick="showSavedTab('reels')" id="reelsSavedTab" style="padding: 1rem 2rem; background: none; border: none; color: #8e8e8e; cursor: pointer; border-bottom: 2px solid transparent;">Reels</button>
            </div>
            <div id="savedContent" style="max-height: 400px; overflow-y: auto;">
              <div style="text-align: center; padding: 2rem; color: #8e8e8e;">Loading saved posts...</div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      await loadSavedContent('all');
    }

    async function showSavedTab(tabType) {
      document.querySelectorAll('.saved-tab').forEach(tab => {
        tab.style.color = '#8e8e8e';
        tab.style.borderBottomColor = 'transparent';
      });
      
      const activeTab = document.getElementById(`${tabType}SavedTab`);
      if (activeTab) {
        activeTab.style.color = '#ffffff';
        activeTab.style.borderBottomColor = '#ffffff';
      }
      
      await loadSavedContent(tabType);
    }

    async function loadSavedContent(type) {
      try {
        const { data: savedPosts, error } = await window.sb
          .from('saved_posts')
          .select(`
            *,
            posts(
              id,
              caption,
              image_url,
              created_at,
              user_id
            )
          `)
          .eq('user_id', window.currentUser.id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('savedContent');
        let html = '';
        
        if (savedPosts?.length) {
          let filteredPosts = savedPosts;
          
          if (type === 'posts') {
            filteredPosts = savedPosts.filter(item => 
              !item.posts.image_url || 
              (!item.posts.image_url.includes('video') && !item.posts.image_url.startsWith('data:video'))
            );
          } else if (type === 'reels') {
            filteredPosts = savedPosts.filter(item => 
              item.posts.image_url && 
              (item.posts.image_url.includes('video') || item.posts.image_url.startsWith('data:video'))
            );
          }
          
          if (filteredPosts.length > 0) {
            html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">';
            for (const item of filteredPosts) {
              const post = item.posts;
              const isVideo = post.image_url && (post.image_url.includes('video') || post.image_url.startsWith('data:video'));
              
              // Get user profile
              let username = 'User';
              try {
                const { data: profile } = await window.sb
                  .from('profiles')
                  .select('username')
                  .eq('id', post.user_id)
                  .single();
                if (profile) username = profile.username;
              } catch (err) {
                console.log('Profile not found for user:', post.user_id);
              }
              
              html += `
                <div onclick="openContentPopup('${post.id}', '${isVideo ? 'reel' : 'post'}')" style="aspect-ratio: 1; background: #333; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative;">
                  ${post.image_url ? (isVideo ? 
                    `<video src="${post.image_url}" style="width: 100%; height: 100%; object-fit: cover;" muted />` :
                    `<img src="${post.image_url}" style="width: 100%; height: 100%; object-fit: cover;" />`
                  ) : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff;">üìù</div>'}
                  <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); border-radius: 50%; padding: 4px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#ffd700">
                      <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                    </svg>
                  </div>
                  <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 8px; color: white; font-size: 12px;">
                    <div style="font-weight: 600;">${username}</div>
                    <div style="opacity: 0.8;">${formatTime(post.created_at)}</div>
                  </div>
                </div>
              `;
            }
            html += '</div>';
          } else {
            html = `<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No saved ${type === 'all' ? 'posts' : type}</div>`;
          }
        } else {
          html = '<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No saved posts yet</div>';
        }
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading saved posts:', error);
        document.getElementById('savedContent').innerHTML = '<div style="text-align: center; padding: 2rem; color: #ff4757;">Error loading</div>';
      }
    }

    // Make functions globally available
    window.editProfile = editProfile;
    window.saveProfile = saveProfile;
    window.showSettingsModal = showSettingsModal;
    window.showSavedPosts = showSavedPosts;
    window.showSavedTab = showSavedTab;
    window.loadSavedContent = loadSavedContent;
    window.showShareModal = showShareModal;
    window.loadFollowersForShare = loadFollowersForShare;
    window.toggleFollowerSelection = toggleFollowerSelection;
    window.sharePostWithFollowers = sharePostWithFollowers;
    window.showSharedPostsModal = showSharedPostsModal;
    window.loadSharedPosts = loadSharedPosts;
    window.toggleFullscreenChat = toggleFullscreenChat;

    // Toggle fullscreen chat
    function toggleFullscreenChat() {
      const chatArea = document.getElementById('chatArea');
      
      if (chatArea.classList.contains('fullscreen')) {
        chatArea.classList.remove('fullscreen');
        chatArea.style.cssText = '';
        document.querySelector('.bottom-nav').style.display = 'flex';
        document.getElementById('maximizeBtn').innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
          </svg>
        `;
      } else {
        chatArea.classList.add('fullscreen');
        chatArea.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: var(--bg-dark); width: 100vw; height: 100vh;';
        document.querySelector('.bottom-nav').style.display = 'none';
        document.getElementById('maximizeBtn').innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
          </svg>
        `;
      }
    }
    window.togglePostMenu = togglePostMenu;
    window.visitUserProfile = visitUserProfile;
    window.startDirectMessage = startDirectMessage;
    window.followUserFromPost = followUserFromPost;
    window.deletePost = deletePost;
    window.toggleLike = toggleLike;
    window.toggleSave = toggleSave;
    window.showComments = showComments;
    window.sharePost = sharePost;
    window.showLikes = showLikes;
    window.openCreatePostModal = openCreatePostModal;
    window.openCreateReelModal = openCreateReelModal;
    window.showSection = showSection;
    window.goToHome = goToHome;
    window.logout = logout;
    window.loadReelsFeed = loadReelsFeed;
    window.navigateReel = navigateReel;
    window.toggleReelPlayPause = toggleReelPlayPause;
    window.refreshMessages = refreshMessages;
    window.blockCurrentUser = blockCurrentUser;
    window.hideCurrentChat = hideCurrentChat;
    window.showChatThemes = showChatThemes;
    window.applyChatTheme = applyChatTheme;
    window.resetChatTheme = resetChatTheme;
    window.downloadUserData = downloadUserData;
    window.toggleChatLock = toggleChatLock;
    window.setupHideChat = setupHideChat;
    window.viewHiddenChats = viewHiddenChats;
    window.unhideChat = unhideChat;
    window.disableAccount = disableAccount;
    window.showBlockedAccounts = showBlockedAccounts;
    window.openContentPopup = openContentPopup;
    window.closeContentPopup = closeContentPopup;
    window.editContent = editContent;
    window.deleteContent = deleteContent;
    window.showUserContentTab = showUserContentTab;
    window.followUserFromProfile = followUserFromProfile;
    window.closeUserProfileModal = closeUserProfileModal;
    window.addComment = addComment;
    window.closeCommentsModal = closeCommentsModal;
    window.closeShareModal = closeShareModal;
    window.copyPostLink = copyPostLink;
    window.shareToWhatsApp = shareToWhatsApp;
    window.downloadContent = downloadContent;

    // Missing function implementations
    function showShareModal(postId) {
      sharePost(postId);
    }
    
    function loadFollowersForShare() {
      // Placeholder for share functionality
      console.log('Load followers for share');
    }
    
    function toggleFollowerSelection() {
      // Placeholder for follower selection
      console.log('Toggle follower selection');
    }
    
    function sharePostWithFollowers() {
      // Placeholder for sharing with followers
      console.log('Share post with followers');
    }
    
    function showSharedPostsModal() {
      // Placeholder for shared posts modal
      console.log('Show shared posts modal');
    }
    
    function loadSharedPosts() {
      // Placeholder for loading shared posts
      console.log('Load shared posts');
    }
    
    function loadReelsFeed() {
      // Placeholder for reels feed
      console.log('Load reels feed');
    }
    
    function navigateReel() {
      // Placeholder for reel navigation
      console.log('Navigate reel');
    }
    
    function toggleReelPlayPause() {
      // Placeholder for reel play/pause
      console.log('Toggle reel play/pause');
    }
    
    function refreshMessages() {
      if (window.currentChat) {
        loadMessages(window.currentChat.partnerId);
      }
    }
    
    function blockCurrentUser() {
      // Placeholder for blocking user
      console.log('Block current user');
    }
    
    function downloadUserData() {
      // Placeholder for data download
      console.log('Download user data');
    }
    
    function showBlockedAccounts() {
      // Placeholder for blocked accounts
      console.log('Show blocked accounts');
    }
    
    function openContentPopup() {
      // Placeholder for content popup
      console.log('Open content popup');
    }
    
    function closeContentPopup() {
      // Placeholder for closing content popup
      console.log('Close content popup');
    }
    
    function editContent() {
      // Placeholder for editing content
      console.log('Edit content');
    }
    
    function deleteContent() {
      // Placeholder for deleting content
      console.log('Delete content');
    }
    
    function followUserFromProfile() {
      // Placeholder for following from profile
      console.log('Follow user from profile');
    }
    
    function closeUserProfileModal() {
      const modal = document.getElementById('userProfileModal');
      if (modal) modal.remove();
    }
    
    function startDirectMessage(userId, username) {
      openChat(userId, username);
      showSection('messages');
    }
    
    function followUserFromPost() {
      // Placeholder for following from post
      console.log('Follow user from post');
    }
    
    function deletePost() {
      // Placeholder for deleting post
      console.log('Delete post');
    }
    
    function downloadContent() {
      // Placeholder for downloading content
      console.log('Download content');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Check if Supabase is loaded
      if (!window.supabase || !window.sb) {
        console.error('Supabase not loaded properly');
        setTimeout(() => {
          if (!window.supabase || !window.sb) {
            showError('Supabase failed to load. Please check your internet connection and refresh.');
          } else {
            checkAuth();
          }
        }, 2000);
        return;
      }
      
      // Wait for Supabase to load
      setTimeout(checkAuth, 100);
      
      // Event listeners
      document.getElementById('messageForm').addEventListener('submit', sendMessage);
      document.getElementById('btn-logout').addEventListener('click', logout);
      
      // Add typing indicator
      let typingTimer;
      document.getElementById('messageInput').addEventListener('input', (e) => {
        if (window.currentChat && e.target.value.trim()) {
          // Send typing indicator (simplified - in production you'd use a separate table)
          clearTimeout(typingTimer);
          typingTimer = setTimeout(() => {
            // Stop typing after 2 seconds of inactivity
          }, 2000);
        }
      });
      
      // Auto-focus message input when chat opens
      document.getElementById('messageInput').addEventListener('focus', () => {
        setTimeout(() => {
          const messagesContainer = document.getElementById('messages');
          if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        }, 100);
      });
      
      // Enter key to send message (Shift+Enter for new line)
      document.getElementById('messageInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.getElementById('messageForm').dispatchEvent(new Event('submit'));
        }
      });
      document.getElementById('backToChats').addEventListener('click', () => {
        // Unsubscribe from messages when leaving chat
        if (window.messageSubscription) {
          window.messageSubscription.unsubscribe();
          window.messageSubscription = null;
        }
        
        document.getElementById('chatArea').classList.add('hidden');
        document.getElementById('chatsList').style.display = 'block';
        document.getElementById('chatSearchContainer').style.display = 'block';
        document.getElementById('chatSearchResults').classList.add('hidden');
        window.currentChat = null;
        
        // Reload chats to show available users
        loadChats();
      });
      
      // Clear chat search function
      window.clearChatSearch = function() {
        document.getElementById('chatSearchInput').value = '';
        document.getElementById('clearChatSearch').classList.add('hidden');
        document.getElementById('chatSearchResults').classList.add('hidden');
        document.getElementById('chatsList').style.display = 'block';
        loadChats();
      };
      
      // Show clear button when typing
      document.getElementById('chatSearchInput').addEventListener('input', (e) => {
        const clearBtn = document.getElementById('clearChatSearch');
        if (e.target.value.trim()) {
          clearBtn.classList.remove('hidden');
          searchUsers(e.target.value.trim());
          document.getElementById('chatsList').style.display = 'none';
        } else {
          clearBtn.classList.add('hidden');
          document.getElementById('chatSearchResults').classList.add('hidden');
          document.getElementById('chatsList').style.display = 'block';
          loadChats();
        }
      });
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => showSection(btn.dataset.section));
      });
      
      document.getElementById('searchQuery').addEventListener('input', (e) => {
        if (e.target.value.trim()) {
          searchUsers(e.target.value.trim());
        }
      });
      
      document.getElementById('chatSearchInput').addEventListener('input', (e) => {
        if (e.target.value.trim()) {
          searchUsers(e.target.value.trim());
          document.getElementById('chatsList').style.display = 'none';
        } else {
          document.getElementById('chatSearchResults').classList.add('hidden');
          document.getElementById('chatsList').style.display = 'block';
          loadChats();
        }
      });

      // Modal close handlers
      document.querySelectorAll('.close-btn, .cancel-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const modal = e.target.closest('.modal');
          if (modal) modal.classList.add('hidden');
        });
      });

      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', (e) => {
          const modal = e.target.closest('.modal');
          if (modal) modal.classList.add('hidden');
        });
      });
      
      // Form submission handlers
      document.getElementById('createPostForm')?.addEventListener('submit', handleCreatePost);
      document.getElementById('createReelForm')?.addEventListener('submit', handleCreateReel);
      
      // File input handlers
      document.getElementById('btnPickMedia')?.addEventListener('click', () => {
        document.getElementById('postImage').click();
      });
      
      document.getElementById('btnPickReelVideo')?.addEventListener('click', () => {
        document.getElementById('reelVideo').click();
      });
      
      document.getElementById('postImage')?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          document.getElementById('mediaSelected').textContent = `Selected: ${file.name}`;
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('postPreview');
            if (file.type.startsWith('image/')) {
              preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px;" />`;
            } else if (file.type.startsWith('video/')) {
              preview.innerHTML = `<video src="${e.target.result}" controls style="max-width: 100%; max-height: 200px; border-radius: 8px;" />`;
            }
          };
          reader.readAsDataURL(file);
        }
      });
      
      document.getElementById('reelVideo')?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          document.getElementById('reelVideoSelected').textContent = `Selected: ${file.name}`;
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('reelPreview');
            preview.innerHTML = `<video src="${e.target.result}" controls style="max-width: 100%; max-height: 200px; border-radius: 8px;" />`;
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Add profile tab listeners
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          if (tabName) showProfileTab(tabName);
        });
      });
      
      // Add settings button listener
      document.getElementById('openSettings')?.addEventListener('click', () => {
        showSettingsModal();
      });
      
      // Avatar file upload handler (will be added dynamically)
      document.addEventListener('click', (e) => {
        if (e.target.id === 'btnPickAvatar') {
          document.getElementById('avatarFile').click();
        }
      });
      
      document.addEventListener('change', (e) => {
        if (e.target.id === 'avatarFile') {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const preview = document.getElementById('avatarPreview');
              if (preview) {
                preview.innerHTML = `<img src="${e.target.result}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-top: 8px;" />`;
              }
            };
            reader.readAsDataURL(file);
          }
        }
      });
      
      // Add profile stats listeners
      document.getElementById('followersCount')?.addEventListener('click', showFollowers);
      document.getElementById('followingCount')?.addEventListener('click', showFollowing);
    });
    
    // Settings modal
    async function showSettingsModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-dialog">
          <div class="modal-header">
            <h3>Settings</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body">
            <div class="settings-item" onclick="downloadUserData(); this.closest('.modal').remove();" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: #fff;">
              <h4 style="margin: 0 0 4px 0;">üì• Download Data</h4>
              <p style="margin: 0; color: #8e8e8e; font-size: 14px;">Download all your posts, reels, and messages</p>
            </div>
            <div class="settings-item" onclick="toggleChatLock()" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: #fff; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4 style="margin: 0 0 4px 0;">üîí Chat Lock</h4>
                <p style="margin: 0; color: #8e8e8e; font-size: 14px;">Secure your messages with a password</p>
              </div>
              <div id="chatLockToggle" style="padding: 4px 12px; background: #333; border-radius: 16px; font-size: 12px; color: #8e8e8e;">OFF</div>
            </div>
            <div class="settings-item" onclick="showBlockedAccounts(); this.closest('.modal').remove();" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: #fff;">
              <h4 style="margin: 0 0 4px 0;">üö´ Blocked Accounts</h4>
              <p style="margin: 0; color: #8e8e8e; font-size: 14px;">View and manage blocked users</p>
            </div>
            <div class="settings-item" onclick="setupHideChat(); this.closest('.modal').remove();" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: #fff;">
              <h4 style="margin: 0 0 4px 0;">üëÅÔ∏è Hide Chat</h4>
              <p style="margin: 0; color: #8e8e8e; font-size: 14px;">Set password to hide chats from main list</p>
            </div>
            <div class="settings-item" onclick="showChatThemes(); this.closest('.modal').remove();" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: #fff;">
              <h4 style="margin: 0 0 4px 0;">üé® Chat Themes</h4>
              <p style="margin: 0; color: #8e8e8e; font-size: 14px;">Customize your chat background</p>
            </div>
            <div class="settings-item" onclick="showSavedPosts(); this.closest('.modal').remove();" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: #fff;">
              <h4 style="margin: 0 0 4px 0;">üíæ Saved Posts</h4>
              <p style="margin: 0; color: #8e8e8e; font-size: 14px;">View your saved posts and reels</p>
            </div>
            <div class="settings-item" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); color: #fff;">
              <h4 style="margin: 0 0 8px 0;">üîç Hidden Chats</h4>
              <div id="hiddenChatsList" style="max-height: 200px; overflow-y: auto;">
                <div style="text-align: center; padding: 1rem;">
                  <button onclick="viewHiddenChats()" style="padding: 8px 16px; background: #0095f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    View Hidden Chats
                  </button>
                </div>
              </div>
            </div>
            <div class="settings-item" onclick="disableAccount(); this.closest('.modal').remove();" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: #fff;">
              <h4 style="margin: 0 0 4px 0;">‚è∏Ô∏è Disable Account</h4>
              <p style="margin: 0; color: #8e8e8e; font-size: 14px;">Temporarily disable your account</p>
            </div>
            <div class="settings-item" onclick="logout(); this.closest('.modal').remove();" style="padding: 16px; cursor: pointer; color: #ff4757;">
              <h4 style="margin: 0 0 4px 0;">üö™ Logout</h4>
              <p style="margin: 0; color: #8e8e8e; font-size: 14px;">Sign out of your account</p>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      updateChatLockToggle();
    }

    // Post menu functions
    function togglePostMenu(event, postId, userId, username) {
      event.stopPropagation();
      
      // Close all other menus
      document.querySelectorAll('.post-menu').forEach(menu => {
        if (menu.id !== `postMenu-${postId}`) {
          menu.classList.remove('show');
        }
      });
      
      const menu = document.getElementById(`postMenu-${postId}`);
      if (menu) {
        menu.classList.toggle('show');
      }
    }

    // Visit user profile function
    async function visitUserProfile(userId, username) {
      try {
        // Close the menu
        document.querySelectorAll('.post-menu').forEach(menu => menu.classList.remove('show'));
        
        // Create and show user profile modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-backdrop" onclick="closeUserProfileModal()"></div>
          <div class="modal-dialog" style="max-width: 600px;">
            <div class="modal-header">
              <h3>${username}'s Profile</h3>
              <button onclick="closeUserProfileModal()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body" id="userProfileContent">
              <div style="text-align: center; padding: 2rem; color: #8e8e8e;">Loading profile...</div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        modal.id = 'userProfileModal';
        
        // Load user's posts and reels
        await loadUserContent(userId, username);
        
      } catch (error) {
        console.error('Error visiting user profile:', error);
        alert('Failed to load user profile');
      }
    }

    // Load user content (posts and reels)
    async function loadUserContent(userId, username) {
      try {
        // Get user profile info
        const { data: profile } = await window.sb
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();
        
        // Get user's posts
        const { data: posts } = await window.sb
          .from('posts')
          .select('*')
          .eq('user_id', userId)
          .order('created_at', { ascending: false });
        
        // Get counts
        const { count: postsCount } = await window.sb
          .from('posts')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', userId);
        
        const { count: followersCount } = await window.sb
          .from('follows')
          .select('*', { count: 'exact', head: true })
          .eq('followee_id', userId);
        
        const { count: followingCount } = await window.sb
          .from('follows')
          .select('*', { count: 'exact', head: true })
          .eq('follower_id', userId);
        
        // Check if current user follows this user
        let isFollowing = false;
        if (window.currentUser && userId !== window.currentUser.id) {
          const { data: followData } = await window.sb
            .from('follows')
            .select('id')
            .eq('follower_id', window.currentUser.id)
            .eq('followee_id', userId)
            .maybeSingle();
          isFollowing = !!followData;
        }
        
        const content = document.getElementById('userProfileContent');
        if (!content) return;
        
        let html = `
          <div class="user-profile-header" style="text-align: center; padding: 2rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="profile-avatar-large" style="width: 120px; height: 120px; border-radius: 50%; background: #e1306c; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; overflow: hidden;">
              ${profile?.avatar_url ? 
                `<img src="${profile.avatar_url}" alt="${username}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />` : 
                `<span style="color: white; font-weight: 600; font-size: 2.5rem;">${username[0].toUpperCase()}</span>`
              }
            </div>
            <h2 style="color: #ffffff; margin: 0 0 0.5rem 0;">${username}</h2>
            <p style="color: #8e8e8e; margin: 0 0 1rem 0;">${profile?.full_name || ''}</p>
            ${profile?.bio ? `<p style="color: #ffffff; margin: 0 0 1rem 0;">${profile.bio}</p>` : ''}
            
            <div class="profile-stats" style="display: flex; justify-content: center; gap: 2rem; margin: 1rem 0;">
              <div style="text-align: center;">
                <div style="font-weight: 600; color: #ffffff; font-size: 1.2rem;">${postsCount || 0}</div>
                <div style="color: #8e8e8e; font-size: 0.9rem;">posts</div>
              </div>
              <div style="text-align: center;">
                <div style="font-weight: 600; color: #ffffff; font-size: 1.2rem;">${followersCount || 0}</div>
                <div style="color: #8e8e8e; font-size: 0.9rem;">followers</div>
              </div>
              <div style="text-align: center;">
                <div style="font-weight: 600; color: #ffffff; font-size: 1.2rem;">${followingCount || 0}</div>
                <div style="color: #8e8e8e; font-size: 0.9rem;">following</div>
              </div>
            </div>
            
            ${window.currentUser && userId !== window.currentUser.id ? `
              <div class="profile-actions" style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;">
                <button class="btn ${isFollowing ? 'btn-secondary' : 'btn-primary'}" onclick="followUserFromProfile('${userId}', '${username}')" id="followBtn-${userId}">
                  ${isFollowing ? 'Following' : 'Follow'}
                </button>
                <button class="btn btn-secondary" onclick="startDirectMessage('${userId}', '${username}'); closeUserProfileModal();">
                  Message
                </button>
              </div>
            ` : ''}
          </div>
          
          <div class="user-content-tabs" style="display: flex; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <button class="profile-tab active" onclick="showUserContentTab('posts', '${userId}')" id="postsTab" style="padding: 1rem 2rem; background: none; border: none; color: #ffffff; cursor: pointer; border-bottom: 2px solid #ffffff;">
              Posts
            </button>
            <button class="profile-tab" onclick="showUserContentTab('reels', '${userId}')" id="reelsTab" style="padding: 1rem 2rem; background: none; border: none; color: #8e8e8e; cursor: pointer; border-bottom: 2px solid transparent;">
              Reels
            </button>
          </div>
          
          <div class="user-content-area" id="userContentArea">
            <div id="userPostsContent" class="user-content-tab active">
              <div style="text-align: center; padding: 2rem; color: #8e8e8e;">Loading posts...</div>
            </div>
            <div id="userReelsContent" class="user-content-tab" style="display: none;">
              <div style="text-align: center; padding: 2rem; color: #8e8e8e;">Loading reels...</div>
            </div>
          </div>
        `;
        
        content.innerHTML = html;
        
        // Load posts by default
        await showUserContentTab('posts', userId);
        
      } catch (error) {
        console.error('Error loading user content:', error);
        const content = document.getElementById('userProfileContent');
        if (content) {
          content.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ff4757;">Error loading profile</div>';
        }
      }
    }

    // Show user content tab
    async function showUserContentTab(tabName, userId) {
      // Update tab buttons
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.style.color = '#8e8e8e';
        tab.style.borderBottomColor = 'transparent';
      });
      
      const activeTab = document.getElementById(`${tabName}Tab`);
      if (activeTab) {
        activeTab.style.color = '#ffffff';
        activeTab.style.borderBottomColor = '#ffffff';
      }
      
      // Show content
      document.querySelectorAll('.user-content-tab').forEach(content => {
        content.style.display = 'none';
      });
      
      const activeContent = document.getElementById(`user${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Content`);
      if (activeContent) {
        activeContent.style.display = 'block';
      }
      
      // Load content
      if (tabName === 'posts') {
        await loadUserPosts(userId);
      } else if (tabName === 'reels') {
        await loadUserReels(userId);
      }
    }

    // Load user posts
    async function loadUserPosts(userId) {
      const targetUserId = userId || window.currentUser?.id;
      if (!targetUserId) {
        console.error('No user ID provided for loading posts');
        return;
      }
      
      try {
        const { data: posts } = await window.sb
          .from('posts')
          .select('*')
          .eq('user_id', targetUserId)
          .order('created_at', { ascending: false });
        
        const container = document.getElementById('userPostsContent') || document.getElementById('postsContent');
        if (!container) {
          console.error('User posts container not found');
          return;
        }
        
        let html = '';
        
        if (posts?.length) {
          html = '<div class="posts-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 1rem;">';
          posts.forEach(post => {
            const isVideo = post.image_url && (post.image_url.includes('video') || post.image_url.startsWith('data:video'));
            const contentType = isVideo ? 'reel' : 'post';
            html += `
              <div class="post-item" onclick="openContentPopup('${post.id}', '${contentType}')" style="aspect-ratio: 1; background: #333; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative;">
                ${post.image_url ? (isVideo ? 
                  `<video src="${post.image_url}" style="width: 100%; height: 100%; object-fit: cover;" muted />` :
                  `<img src="${post.image_url}" alt="Post" style="width: 100%; height: 100%; object-fit: cover;" />`
                ) : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; font-size: 2rem;">üìù</div>'}
                <div class="post-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;">
                  <span style="color: white; font-weight: 600;">‚ù§Ô∏è 0 üí¨ 0</span>
                </div>
              </div>
            `;
          });
          html += '</div>';
        } else {
          html = '<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No posts yet</div>';
        }
        
        container.innerHTML = html;
        
        // Add hover effects
        container.querySelectorAll('.post-item').forEach(item => {
          item.addEventListener('mouseenter', () => {
            const overlay = item.querySelector('.post-overlay');
            if (overlay) overlay.style.opacity = '1';
          });
          item.addEventListener('mouseleave', () => {
            const overlay = item.querySelector('.post-overlay');
            if (overlay) overlay.style.opacity = '0';
          });
        });
        
      } catch (error) {
        console.error('Error loading user posts:', error);
      }
    }

    // Load user reels
    async function loadUserReels(userId) {
      const targetUserId = userId || window.currentUser?.id;
      if (!targetUserId) {
        console.error('No user ID provided for loading reels');
        return;
      }
      
      try {
        const { data: reels } = await window.sb
          .from('posts')
          .select('*')
          .eq('user_id', targetUserId)
          .order('created_at', { ascending: false });
        
        // Filter for video content
        const videoReels = reels?.filter(reel => 
          reel.image_url && (reel.image_url.includes('video') || reel.image_url.startsWith('data:video'))
        ) || [];
        
        // Get user profile for avatar
        const { data: profile } = await window.sb
          .from('profiles')
          .select('username, avatar_url')
          .eq('id', targetUserId)
          .single();
        
        const container = document.getElementById('userReelsContent') || document.getElementById('reelsContent');
        if (!container) {
          console.error('User reels container not found');
          return;
        }
        
        let html = '';
        
        if (videoReels.length) {
          html = '<div class="reels-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 1rem;">';
          videoReels.forEach(reel => {
            html += `
              <div class="reel-item" onclick="openContentPopup('${reel.id}', 'reel')" style="aspect-ratio: 9/16; background: #333; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative;">
                <video src="${reel.image_url}" style="width: 100%; height: 100%; object-fit: cover;" muted />
                <div class="reel-cover-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(transparent 60%, rgba(0,0,0,0.8)); display: flex; flex-direction: column; justify-content: space-between; padding: 8px;">
                  <div class="reel-avatar" style="width: 24px; height: 24px; border-radius: 50%; overflow: hidden; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                    ${profile?.avatar_url ? 
                      `<img src="${profile.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;" />` : 
                      `${profile?.username?.[0]?.toUpperCase() || 'U'}`
                    }
                  </div>
                  <div class="reel-play-icon" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.2s;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        } else {
          html = '<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No reels yet</div>';
        }
        
        container.innerHTML = html;
        
        // Add hover effects
        container.querySelectorAll('.reel-item').forEach(item => {
          item.addEventListener('mouseenter', () => {
            const playIcon = item.querySelector('.reel-play-icon');
            if (playIcon) playIcon.style.opacity = '1';
          });
          item.addEventListener('mouseleave', () => {
            const playIcon = item.querySelector('.reel-play-icon');
            if (playIcon) playIcon.style.opacity = '0';
          });
        });
        
      } catch (error) {
        console.error('Error loading user reels:', error);
      }
    }

    // Close user profile modal
    function closeUserProfileModal() {
      const modal = document.getElementById('userProfileModal');
      if (modal) {
        modal.remove();
      }
    }

    // Start direct message from post menu
    function startDirectMessage(userId, username) {
      // Close the menu
      document.querySelectorAll('.post-menu').forEach(menu => menu.classList.remove('show'));
      
      // Switch to messages section
      showSection('messages');
      
      // Small delay to ensure section is loaded and then open chat
      setTimeout(() => {
        openChat(userId, username);
      }, 300);
    }

    // Follow user from post menu
    async function followUserFromPost(userId, username) {
      if (!window.currentUser) {
        alert('Please log in to follow users');
        return;
      }
      
      if (userId === window.currentUser.id) {
        alert('You cannot follow yourself');
        return;
      }
      
      // Close the menu
      document.querySelectorAll('.post-menu').forEach(menu => menu.classList.remove('show'));
      
      try {
        const { data: existingFollow } = await window.sb
          .from('follows')
          .select('*')
          .eq('follower_id', window.currentUser.id)
          .eq('followee_id', userId)
          .maybeSingle();
        
        if (existingFollow) {
          await window.sb
            .from('follows')
            .delete()
            .eq('follower_id', window.currentUser.id)
            .eq('followee_id', userId);
          
          alert(`Unfollowed ${username}`);
        } else {
          await window.sb
            .from('follows')
            .insert({
              follower_id: window.currentUser.id,
              followee_id: userId
            });
          
          alert(`Now following ${username}`);
        }
        
      } catch (error) {
        console.error('Error following user:', error);
        alert('Failed to follow/unfollow user');
      }
    }

    // Follow user from profile modal
    async function followUserFromProfile(userId, username) {
      if (!window.currentUser) {
        alert('Please log in to follow users');
        return;
      }
      
      const followBtn = document.getElementById(`followBtn-${userId}`);
      if (!followBtn) return;
      
      const originalText = followBtn.textContent;
      followBtn.disabled = true;
      followBtn.textContent = 'Loading...';
      
      try {
        const { data: existingFollow } = await window.sb
          .from('follows')
          .select('*')
          .eq('follower_id', window.currentUser.id)
          .eq('followee_id', userId)
          .maybeSingle();
        
        if (existingFollow) {
          await window.sb
            .from('follows')
            .delete()
            .eq('follower_id', window.currentUser.id)
            .eq('followee_id', userId);
          
          followBtn.textContent = 'Follow';
          followBtn.className = 'btn btn-primary';
        } else {
          await window.sb
            .from('follows')
            .insert({
              follower_id: window.currentUser.id,
              followee_id: userId
            });
          
          followBtn.textContent = 'Following';
          followBtn.className = 'btn btn-secondary';
        }
        
      } catch (error) {
        console.error('Error following user:', error);
        followBtn.textContent = originalText;
        alert('Failed to follow/unfollow user');
      } finally {
        followBtn.disabled = false;
      }
    }

    // Delete post function
    async function deletePost(postId) {
      if (!window.currentUser) {
        alert('Please log in to delete posts');
        return;
      }
      
      if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
      }
      
      try {
        // Close the menu
        document.querySelectorAll('.post-menu').forEach(menu => menu.classList.remove('show'));
        
        const { error } = await window.sb
          .from('posts')
          .delete()
          .eq('id', postId)
          .eq('user_id', window.currentUser.id);
        
        if (error) throw error;
        
        // Refresh the feed
        await loadFeed();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = 'Post deleted successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('Failed to delete post. Please try again.');
      }
    }

    // Download user data
    async function downloadUserData() {
      if (!window.currentUser) {
        alert('Please log in to download data');
        return;
      }
      
      try {
        const userId = window.currentUser.id;
        const userData = {
          profile: window.currentUser.profile,
          posts: [],
          messages: [],
          downloadDate: new Date().toISOString()
        };
        
        // Get user posts
        const { data: posts } = await window.sb
          .from('posts')
          .select('*')
          .eq('user_id', userId)
          .order('created_at', { ascending: false });
        userData.posts = posts || [];
        
        // Get user messages
        const { data: messages } = await window.sb
          .from('messages')
          .select('*')
          .or(`sender_id.eq.${userId},receiver_id.eq.${userId}`)
          .order('created_at', { ascending: false });
        userData.messages = messages || [];
        
        // Create and download JSON file
        const dataStr = JSON.stringify(userData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `genzes-chat-data-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert('Your data has been downloaded successfully!');
        
      } catch (error) {
        console.error('Error downloading data:', error);
        alert('Failed to download data. Please try again.');
      }
    }

    // Open content popup (post/reel)
    async function openContentPopup(contentId, contentType) {
      try {
        const { data: content, error } = await window.sb
          .from('posts')
          .select('*')
          .eq('id', contentId)
          .single();
        
        if (error) throw error;
        
        const { data: profile } = await window.sb
          .from('profiles')
          .select('username, avatar_url')
          .eq('id', content.user_id)
          .single();
        
        const isVideo = content.image_url && (content.image_url.includes('video') || content.image_url.startsWith('data:video'));
        const isOwner = window.currentUser && content.user_id === window.currentUser.id;
        
        const modal = document.createElement('div');
        modal.id = 'contentPopupModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-backdrop" onclick="closeContentPopup()"></div>
          <div class="modal-dialog" style="max-width: 500px; max-height: 90vh;">
            <div class="modal-header">
              <h3>${contentType === 'reel' ? 'Reel' : 'Post'}</h3>
              <button onclick="closeContentPopup()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body" style="padding: 0;">
              <div class="content-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                    ${profile?.avatar_url ? 
                      `<img src="${profile.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;" />` : 
                      `${profile?.username?.[0]?.toUpperCase() || 'U'}`
                    }
                  </div>
                  <div>
                    <div style="color: #ffffff; font-weight: 600;">${profile?.username || 'User'}</div>
                    <div style="color: #8e8e8e; font-size: 0.8rem;">${formatTime(content.created_at)}</div>
                  </div>
                </div>
                ${isOwner ? `
                  <div class="content-actions" style="display: flex; gap: 8px;">
                    <button onclick="editContent('${contentId}', '${contentType}')" style="padding: 8px 16px; background: #0095f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                      Edit
                    </button>
                    <button onclick="deleteContent('${contentId}', '${contentType}')" style="padding: 8px 16px; background: #ff4757; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                      Delete
                    </button>
                  </div>
                ` : ''}
              </div>
              
              <div class="content-media" style="background: #000; display: flex; align-items: center; justify-content: center;">
                ${content.image_url ? (isVideo ? 
                  `<video src="${content.image_url}" controls style="width: 100%; max-height: 400px; object-fit: contain;" />` :
                  `<img src="${content.image_url}" alt="Content" style="width: 100%; max-height: 400px; object-fit: contain;" />`
                ) : '<div style="padding: 2rem; color: #8e8e8e; text-align: center;">No media</div>'}
              </div>
              
              ${content.caption ? `
                <div class="content-caption" style="padding: 1rem; color: #ffffff; border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <strong>${profile?.username || 'User'}</strong> ${content.caption}
                </div>
              ` : ''}
              
              <div class="content-stats" style="padding: 1rem; color: #8e8e8e; font-size: 0.9rem;">
                <div>Audience: ${content.audience || 'public'}</div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
      } catch (error) {
        console.error('Error opening content popup:', error);
        alert('Failed to load content');
      }
    }
    
    // Close content popup
    function closeContentPopup() {
      const modal = document.getElementById('contentPopupModal');
      if (modal) modal.remove();
    }
    
    // Edit content
    async function editContent(contentId, contentType) {
      try {
        const { data: content } = await window.sb
          .from('posts')
          .select('*')
          .eq('id', contentId)
          .single();
        
        if (!content) {
          alert('Content not found');
          return;
        }
        
        const newCaption = prompt('Edit caption:', content.caption || '');
        if (newCaption === null) return; // User cancelled
        
        const { error } = await window.sb
          .from('posts')
          .update({ caption: newCaption.trim() || null })
          .eq('id', contentId)
          .eq('user_id', window.currentUser.id);
        
        if (error) throw error;
        
        closeContentPopup();
        
        // Refresh feed and profile
        await loadFeed();
        if (document.getElementById('postsContent')) {
          await loadUserPosts();
        }
        if (document.getElementById('reelsContent')) {
          await loadUserReels();
        }
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = `${contentType === 'reel' ? 'Reel' : 'Post'} updated successfully!`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error editing content:', error);
        alert('Failed to edit content');
      }
    }
    
    // Delete content
    async function deleteContent(contentId, contentType) {
      if (!confirm(`Are you sure you want to delete this ${contentType}? This action cannot be undone.`)) {
        return;
      }
      
      try {
        const { error } = await window.sb
          .from('posts')
          .delete()
          .eq('id', contentId)
          .eq('user_id', window.currentUser.id);
        
        if (error) throw error;
        
        closeContentPopup();
        
        // Refresh feed and profile
        await loadFeed();
        if (document.getElementById('postsContent')) {
          await loadUserPosts();
        }
        if (document.getElementById('reelsContent')) {
          await loadUserReels();
        }
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = `${contentType === 'reel' ? 'Reel' : 'Post'} deleted successfully!`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error deleting content:', error);
        alert('Failed to delete content');
      }
    }

    // Missing functions that are referenced in HTML
    function refreshMessages() {
      if (window.currentChat) {
        loadMessages(window.currentChat.partnerId);
      } else {
        loadChats();
      }
    }

    function blockCurrentUser() {
      if (!window.currentChat) {
        alert('No active chat to block');
        return;
      }
      
      if (confirm(`Block ${window.currentChat.partnerName}? They won't be able to message you.`)) {
        alert('Block functionality - coming soon!');
      }
    }

    function showBlockedAccounts() {
      alert('Blocked accounts feature - coming soon!');
    }

    function downloadContent(postId) {
      alert('Download content feature - coming soon!');
    }

    // Show share modal
    async function showShareModal(postId) {
      if (!window.currentUser) {
        alert('Please log in to share posts');
        return;
      }
      
      // Get followers list
      const { data: followers } = await window.sb
        .from('follows')
        .select('followee_id')
        .eq('follower_id', window.currentUser.id);
      
      if (!followers?.length) {
        alert('You need to follow someone to share posts');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-dialog">
          <div class="modal-header">
            <h3>Share Post</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body" style="padding: 1rem;">
            <div style="margin-bottom: 1rem;">
              <label style="color: #ffffff; margin-bottom: 0.5rem; display: block;">Add a caption:</label>
              <textarea id="shareCaption" placeholder="Write something about this post..." style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #ffffff; resize: vertical; min-height: 80px;"></textarea>
            </div>
            <div style="margin-bottom: 1rem;">
              <label style="color: #ffffff; margin-bottom: 0.5rem; display: block;">Share with:</label>
              <div id="followersList" style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 0.5rem;">
                <div style="text-align: center; padding: 1rem; color: #8e8e8e;">Loading followers...</div>
              </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button onclick="this.closest('.modal').remove()" style="padding: 0.75rem 1rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
              <button onclick="sharePostWithFollowers('${postId}')" style="padding: 0.75rem 1rem; background: #0095f6; color: white; border: none; border-radius: 8px; cursor: pointer;">Share</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      await loadFollowersForShare(followers);
    }

    // Load followers for sharing
    async function loadFollowersForShare(followers) {
      const container = document.getElementById('followersList');
      let html = '';
      
      for (const follow of followers) {
        const { data: profile } = await window.sb
          .from('profiles')
          .select('username, avatar_url')
          .eq('id', follow.followee_id)
          .single();
        
        if (profile) {
          html += `
            <div class="follower-item" style="display: flex; align-items: center; gap: 12px; padding: 8px; cursor: pointer; border-radius: 8px; transition: background 0.2s;" onclick="toggleFollowerSelection('${follow.followee_id}', this)" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" id="follower-${follow.followee_id}" style="margin: 0;" />
              <div style="width: 32px; height: 32px; border-radius: 50%; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; overflow: hidden;">
                ${profile.avatar_url ? `<img src="${profile.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;" />` : profile.username[0].toUpperCase()}
              </div>
              <span style="color: #ffffff; font-weight: 500;">${profile.username}</span>
            </div>
          `;
        }
      }
      
      container.innerHTML = html || '<div style="text-align: center; padding: 1rem; color: #8e8e8e;">No followers found</div>';
    }

    // Toggle follower selection
    function toggleFollowerSelection(followerId, element) {
      const checkbox = element.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      element.style.background = checkbox.checked ? 'rgba(0, 149, 246, 0.2)' : 'transparent';
    }

    // Share post with selected followers
    async function sharePostWithFollowers(postId) {
      const caption = document.getElementById('shareCaption').value.trim();
      const selectedFollowers = [];
      
      document.querySelectorAll('#followersList input[type="checkbox"]:checked').forEach(checkbox => {
        const followerId = checkbox.id.replace('follower-', '');
        selectedFollowers.push(followerId);
      });
      
      if (selectedFollowers.length === 0) {
        alert('Please select at least one person to share with');
        return;
      }
      
      try {
        const sharePromises = selectedFollowers.map(receiverId => 
          window.sb.from('messages').insert({
            sender_id: window.currentUser.id,
            receiver_id: receiverId,
            content: caption || null,
            message_type: 'shared_post',
            shared_post_id: postId
          })
        );
        
        await Promise.all(sharePromises);
        
        document.querySelector('.modal').remove();
        
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = `Post shared with ${selectedFollowers.length} ${selectedFollowers.length === 1 ? 'person' : 'people'}!`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error sharing post:', error);
        alert('Failed to share post. Please try again.');
      }
    }

    // Show shared posts modal
    async function showSharedPostsModal() {
      if (!window.currentUser) {
        alert('Please log in to view shared posts');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-dialog" style="max-width: 600px;">
          <div class="modal-header">
            <h3>Shared Posts</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body" style="padding: 1rem;">
            <div id="sharedPostsContent" style="max-height: 400px; overflow-y: auto;">
              <div style="text-align: center; padding: 2rem; color: #8e8e8e;">Loading shared posts...</div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      await loadSharedPosts();
    }

    // Load shared posts
    async function loadSharedPosts() {
      try {
        const { data: sharedPosts } = await window.sb
          .from('shared_posts')
          .select(`
            *,
            posts(
              id,
              caption,
              image_url,
              created_at
            )
          `)
          .eq('receiver_id', window.currentUser.id)
          .order('created_at', { ascending: false });
        
        const container = document.getElementById('sharedPostsContent');
        let html = '';
        
        if (sharedPosts?.length) {
          for (const share of sharedPosts) {
            const post = share.posts;
            const isVideo = post.image_url && (post.image_url.includes('video') || post.image_url.startsWith('data:video'));
            
            // Get sender profile
            let senderName = 'User';
            try {
              const { data: profile } = await window.sb
                .from('profiles')
                .select('username')
                .eq('id', share.sender_id)
                .single();
              if (profile) senderName = profile.username;
            } catch (err) {
              console.log('Profile not found');
            }
            
            html += `
              <div class="shared-post-item" style="border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 16px; overflow: hidden; background: rgba(255,255,255,0.02);">
                <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <div style="color: #0095f6; font-weight: 600; margin-bottom: 4px;">${senderName} shared a post</div>
                  <div style="color: #8e8e8e; font-size: 12px;">${formatTime(share.created_at)}</div>
                  ${share.caption ? `<div style="color: #ffffff; margin-top: 8px; font-style: italic;">‚Äú${share.caption}‚Äù</div>` : ''}
                </div>
                <div onclick="openContentPopup('${post.id}', '${isVideo ? 'reel' : 'post'}')" style="cursor: pointer; position: relative;">
                  ${post.image_url ? (isVideo ? 
                    `<video src="${post.image_url}" style="width: 100%; max-height: 300px; object-fit: cover;" muted />` :
                    `<img src="${post.image_url}" style="width: 100%; max-height: 300px; object-fit: cover;" />`
                  ) : '<div style="padding: 2rem; text-align: center; color: #8e8e8e;">Text post</div>'}
                  ${post.caption ? `<div style="padding: 12px; color: #ffffff; background: rgba(0,0,0,0.7);">${post.caption}</div>` : ''}
                </div>
              </div>
            `;
          }
        } else {
          html = '<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No shared posts yet</div>';
        }
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading shared posts:', error);
        document.getElementById('sharedPostsContent').innerHTML = '<div style="text-align: center; padding: 2rem; color: #ff4757;">Error loading shared posts</div>';
      }
    }

    function navigateReel(direction) {
      if (direction === 'up' && currentReelIndex > 0) {
        currentReelIndex--;
      } else if (direction === 'down' && currentReelIndex < reelsData.length - 1) {
        currentReelIndex++;
      }
      
      const reelItems = document.querySelectorAll('.reel-video-item');
      reelItems.forEach((item, index) => {
        item.style.transform = `translateY(${(index - currentReelIndex) * 100}%)`;
      });
      
      document.getElementById('reelUpBtn').style.display = currentReelIndex > 0 ? 'block' : 'none';
      document.getElementById('reelDownBtn').style.display = currentReelIndex < reelsData.length - 1 ? 'block' : 'none';
    }

    function toggleReelPlayPause(video) {
      if (video.paused) {
        video.play();
      } else {
        video.pause();
      }
    }

    // Reels feed functionality
    let currentReelIndex = 0;
    let reelsData = [];
    
    // Load reels feed
    async function loadReelsFeed() {
      try {
        const { data: posts, error } = await window.sb
          .from('posts')
          .select('*')
          .not('image_url', 'is', null)
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        reelsData = posts?.filter(post => 
          post.image_url && (post.image_url.includes('video') || post.image_url.startsWith('data:video'))
        ) || [];
        
        if (reelsData.length === 0) {
          document.getElementById('reelsFeed').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; text-align: center;"><div><h3>No Reels Available</h3><p>Be the first to create a reel!</p></div></div>';
          return;
        }
        
        await renderReelsFeed();
        
      } catch (error) {
        console.error('Error loading reels feed:', error);
        document.getElementById('reelsFeed').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white;">Error loading reels</div>';
      }
    }
    
    // Render reels feed
    async function renderReelsFeed() {
      const container = document.getElementById('reelsFeed');
      container.innerHTML = '';
      
      for (let i = 0; i < reelsData.length; i++) {
        const reel = reelsData[i];
        
        let user = null;
        try {
          const { data: profile } = await window.sb
            .from('profiles')
            .select('username, avatar_url')
            .eq('id', reel.user_id)
            .single();
          user = profile;
        } catch (err) {
          console.log('Profile not found for user:', reel.user_id);
        }
        
        let likesCount = 0;
        let isLiked = false;
        
        try {
          const { count } = await window.sb
            .from('likes')
            .select('*', { count: 'exact', head: true })
            .eq('post_id', reel.id);
          likesCount = count || 0;
          
          if (window.currentUser) {
            const { data: userLike } = await window.sb
              .from('likes')
              .select('id')
              .eq('post_id', reel.id)
              .eq('user_id', window.currentUser.id)
              .maybeSingle();
            isLiked = !!userLike;
          }
        } catch (err) {
          console.log('Error getting reel stats:', err);
        }
        
        const reelElement = document.createElement('div');
        reelElement.className = 'reel-video-item';
        reelElement.style.transform = `translateY(${i * 100}%)`;
        reelElement.innerHTML = `
          <video 
            class="reel-video" 
            src="${reel.image_url}" 
            loop 
            muted
            playsinline
            onclick="toggleReelPlayPause(this)"
            data-reel-id="${reel.id}"
          ></video>
          
          <div class="reel-controls">
            <button class="reel-control-btn" onclick="toggleReelMute(${i})" id="muteBtn-${i}" title="Mute/Unmute">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
              </svg>
            </button>
          </div>
          
          <div class="reel-info">
            <div class="reel-user">
              <div class="reel-avatar">
                ${user?.avatar_url ? 
                  `<img src="${user.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;" />` : 
                  `${user?.username?.[0]?.toUpperCase() || 'U'}`
                }
              </div>
              <div class="reel-username" onclick="visitUserProfile('${reel.user_id}', '${user?.username || 'User'}'); event.stopPropagation();" style="cursor: pointer;">${user?.username || 'User'}</div>
            </div>
            ${reel.caption ? `<div class="reel-caption">${reel.caption}</div>` : ''}
          </div>
          
          <div class="reel-actions">
            <button class="reel-action-btn" onclick="navigateReel('up')" ${currentReelIndex === 0 ? 'style="opacity: 0.3; pointer-events: none;"' : ''}>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
              </svg>
            </button>
            
            <button class="reel-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleReelLike('${reel.id}', this)" data-reel-id="${reel.id}">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              <span class="reel-action-count">${likesCount}</span>
            </button>
            
            <button class="reel-action-btn" onclick="showReelComments('${reel.id}')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              <span class="reel-action-count">0</span>
            </button>
            
            <button class="reel-action-btn" onclick="shareReel('${reel.id}')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                <polyline points="16,6 12,2 8,6"/>
                <line x1="12" y1="2" x2="12" y2="15"/>
              </svg>
            </button>
            
            <button class="reel-action-btn" onclick="navigateReel('down')" ${currentReelIndex === reelsData.length - 1 ? 'style="opacity: 0.3; pointer-events: none;"' : ''}>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
              </svg>
            </button>
          </div>
        `;
        
        container.appendChild(reelElement);
      }
      
      if (reelsData.length > 0) {
        const firstVideo = container.querySelector('.reel-video');
        if (firstVideo) {
          firstVideo.play().catch(e => console.log('Auto-play failed:', e));
        }
      }
      
      updateNavigationButtons();
    }
    
    // Navigate between reels
    function navigateReel(direction) {
      if (reelsData.length === 0) return;
      
      const container = document.getElementById('reelsFeed');
      const videos = container.querySelectorAll('.reel-video');
      
      if (videos[currentReelIndex]) {
        videos[currentReelIndex].pause();
      }
      
      if (direction === 'up' && currentReelIndex > 0) {
        currentReelIndex--;
      } else if (direction === 'down' && currentReelIndex < reelsData.length - 1) {
        currentReelIndex++;
      }
      
      const reelItems = container.querySelectorAll('.reel-video-item');
      reelItems.forEach((item, index) => {
        item.style.transform = `translateY(${(index - currentReelIndex) * 100}%)`;
      });
      
      if (videos[currentReelIndex]) {
        videos[currentReelIndex].play().catch(e => console.log('Play failed:', e));
      }
      
      updateNavigationButtons();
    }
    
    // Update navigation buttons
    function updateNavigationButtons() {
      const upBtn = document.getElementById('reelUpBtn');
      const downBtn = document.getElementById('reelDownBtn');
      
      if (upBtn) upBtn.style.display = currentReelIndex > 0 ? 'flex' : 'none';
      if (downBtn) downBtn.style.display = currentReelIndex < reelsData.length - 1 ? 'flex' : 'none';
    }
    
    // Toggle play/pause
    function toggleReelPlayPause(video) {
      if (video.paused) {
        video.play();
      } else {
        video.pause();
      }
    }
    
    // Toggle mute/unmute
    function toggleReelMute(index) {
      const container = document.getElementById('reelsFeed');
      const video = container.querySelectorAll('.reel-video')[index];
      const muteBtn = document.getElementById(`muteBtn-${index}`);
      
      if (video) {
        video.muted = !video.muted;
        muteBtn.innerHTML = video.muted ? 
          `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
          </svg>` :
          `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
          </svg>`;
      }
    }
    
    // Toggle reel like
    async function toggleReelLike(reelId, button) {
      if (!window.currentUser) {
        alert('Please log in to like reels');
        return;
      }
      
      try {
        const { data: existingLike } = await window.sb
          .from('likes')
          .select('*')
          .eq('post_id', reelId)
          .eq('user_id', window.currentUser.id)
          .maybeSingle();
        
        const countSpan = button.querySelector('.reel-action-count');
        const svg = button.querySelector('svg');
        
        if (existingLike) {
          await window.sb
            .from('likes')
            .delete()
            .eq('post_id', reelId)
            .eq('user_id', window.currentUser.id);
          
          button.classList.remove('liked');
          svg.setAttribute('fill', 'none');
          countSpan.textContent = Math.max(0, parseInt(countSpan.textContent) - 1);
        } else {
          await window.sb
            .from('likes')
            .insert({
              post_id: reelId,
              user_id: window.currentUser.id
            });
          
          button.classList.add('liked');
          svg.setAttribute('fill', 'currentColor');
          countSpan.textContent = parseInt(countSpan.textContent) + 1;
        }
        
      } catch (error) {
        console.error('Error toggling reel like:', error);
      }
    }
    
    // Show reel comments
    function showReelComments(reelId) {
      showComments(reelId);
    }
    
    // Share reel
    function shareReel(reelId) {
      sharePost(reelId);
    }
    
    // Download content function
    async function downloadContent(contentId) {
      try {
        const { data: content } = await window.sb
          .from('posts')
          .select('*')
          .eq('id', contentId)
          .single();
        
        if (!content || !content.image_url) {
          alert('Content not found or no media available');
          return;
        }
        
        const { data: profile } = await window.sb
          .from('profiles')
          .select('username')
          .eq('id', content.user_id)
          .single();
        
        const isVideo = content.image_url.includes('video') || content.image_url.startsWith('data:video');
        const extension = isVideo ? 'mp4' : 'jpg';
        const filename = `${profile?.username || 'user'}_${content.id.slice(0, 8)}.${extension}`;
        
        // Create download link
        const link = document.createElement('a');
        link.href = content.image_url;
        link.download = filename;
        link.target = '_blank';
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        closeShareModal();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = 'Download started!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('Error downloading content:', error);
        alert('Failed to download content');
      }
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (document.getElementById('reelsSection').classList.contains('active')) {
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          navigateReel('up');
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          navigateReel('down');
        } else if (e.key === ' ') {
          e.preventDefault();
          const currentVideo = document.querySelectorAll('.reel-video')[currentReelIndex];
          if (currentVideo) toggleReelPlayPause(currentVideo);
        }
      }
    });

    // Block current user
    async function blockCurrentUser() {
      console.log('Block button clicked');
      console.log('Current chat:', window.currentChat);
      console.log('Current user:', window.currentUser);
      
      if (!window.currentChat || !window.currentUser) {
        alert('No active chat to block');
        return;
      }
      
      try {
        const { data: profile } = await window.sb
          .from('profiles')
          .select('username')
          .eq('id', window.currentChat.partnerId)
          .single();
        
        if (!confirm(`Are you sure you want to block ${profile?.username || 'this user'}?`)) {
          return;
        }
        
        // Check if already blocked
        const { data: existingBlock } = await window.sb
          .from('blocked_users')
          .select('id')
          .eq('blocker_id', window.currentUser.id)
          .eq('blocked_id', window.currentChat.partnerId)
          .maybeSingle();
        
        if (existingBlock) {
          alert('User is already blocked');
          return;
        }
        
        const { error } = await window.sb
          .from('blocked_users')
          .insert({
            blocker_id: window.currentUser.id,
            blocked_id: window.currentChat.partnerId
          });
        
        if (error) throw error;
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff4757; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        successMsg.textContent = `${profile?.username || 'User'} has been blocked`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
        // Go back to chats list immediately
        document.getElementById('chatArea').classList.add('hidden');
        document.getElementById('chatsList').style.display = 'block';
        document.getElementById('chatSearchContainer').style.display = 'block';
        window.currentChat = null;
        
        // Refresh chats to remove blocked user
        await loadChats();
        
      } catch (error) {
        console.error('Error blocking user:', error);
        alert('Failed to block user: ' + error.message);
      }
    }
    
    // Make sure function is globally available
    window.blockCurrentUser = blockCurrentUser;
    
    // Show blocked accounts
    async function showBlockedAccounts() {
      try {
        const { data: blockedUsers } = await window.sb
          .from('blocked_users')
          .select('blocked_id, created_at')
          .eq('blocker_id', window.currentUser.id)
          .order('created_at', { ascending: false });
        
        // Get profile info for each blocked user
        const blockedUsersWithProfiles = [];
        if (blockedUsers?.length) {
          for (const blocked of blockedUsers) {
            const { data: profile } = await window.sb
              .from('profiles')
              .select('username, avatar_url')
              .eq('id', blocked.blocked_id)
              .single();
            
            blockedUsersWithProfiles.push({
              ...blocked,
              profiles: profile
            });
          }
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
          <div class="modal-dialog">
            <div class="modal-header">
              <h3>Blocked Accounts</h3>
              <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
              ${blockedUsersWithProfiles?.length ? blockedUsersWithProfiles.map(blocked => `
                <div class="user-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #e1306c; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                      ${blocked.profiles?.avatar_url ? 
                        `<img src="${blocked.profiles.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />` : 
                        `${blocked.profiles?.username?.[0]?.toUpperCase() || 'U'}`
                      }
                    </div>
                    <div>
                      <div style="color: #ffffff; font-weight: 600;">${blocked.profiles?.username || 'Unknown User'}</div>
                      <div style="color: #8e8e8e; font-size: 12px;">Blocked ${formatTime(blocked.created_at)}</div>
                    </div>
                  </div>
                  <button onclick="unblockUser('${blocked.blocked_id}', '${blocked.profiles?.username || 'User'}')" style="padding: 6px 12px; background: #0095f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    Unblock
                  </button>
                </div>
              `).join('') : '<div style="text-align: center; padding: 2rem; color: #8e8e8e;">No blocked accounts</div>'}
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
      } catch (error) {
        console.error('Error loading blocked accounts:', error);
        alert('Failed to load blocked accounts');
      }
    }
    
    // Unblock user
    async function unblockUser(userId, username) {
      if (!confirm(`Unblock ${username}?`)) return;
      
      try {
        const { error } = await window.sb
          .from('blocked_users')
          .delete()
          .eq('blocker_id', window.currentUser.id)
          .eq('blocked_id', userId);
        
        if (error) throw error;
        
        alert(`${username} has been unblocked`);
        
        // Close and reopen modal to refresh
        document.querySelector('.modal').remove();
        showBlockedAccounts();
        
      } catch (error) {
        console.error('Error unblocking user:', error);
        alert('Failed to unblock user');
      }
    }

    // Refresh messages function
    async function refreshMessages() {
      const refreshBtn = document.getElementById('refreshMessages');
      const svg = refreshBtn.querySelector('svg');
      
      // Add spin animation
      svg.style.animation = 'spin 1s linear infinite';
      refreshBtn.disabled = true;
      
      try {
        if (window.currentChat) {
          await loadMessages(window.currentChat.partnerId);
        } else {
          await loadChats();
        }
      } finally {
        // Remove animation
        svg.style.animation = '';
        refreshBtn.disabled = false;
      }
    }
    
    // Make function globally available
    window.refreshMessages = refreshMessages;
    
    // Settings icon animation
    document.addEventListener('DOMContentLoaded', () => {
      const settingsBtn = document.getElementById('openSettings');
      if (settingsBtn) {
        const svg = settingsBtn.querySelector('svg');
        settingsBtn.addEventListener('mouseenter', () => {
          svg.style.animationDuration = '0.5s';
        });
        settingsBtn.addEventListener('mouseleave', () => {
          svg.style.animationDuration = '4s';
        });
      }
    });

    // Close menus when clicking outside
    document.addEventListener('click', (event) => {
      if (!event.target.closest('.post-more-container')) {
        document.querySelectorAll('.post-menu').forEach(menu => {
          menu.style.opacity = '0';
          menu.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            menu.style.display = 'none';
          }, 300);
        });
      }
    });
  </script>
</body>
</html>