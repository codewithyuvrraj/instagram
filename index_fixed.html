<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Chat App</title>
  <link rel="stylesheet" href="styles.css?v=2" />
  <link rel="stylesheet" href="whatsapp-ui.css?v=2" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="theme-default">

  <header class="site-header">
    <div class="container header-inner">
      <h1 class="logo">GENZES CHATS</h1>
      <nav class="nav">
        <button id="btn-logout" class="btn btn-danger" onclick="logout()">
          <span class="btn-icon">üö™</span>
          <span>Logout</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- App Panel -->
    <div id="appPanel" class="app-container hidden">
      <div class="app-header">
        <button id="backBtn" class="icon-btn" onclick="goToHome()" title="Back" style="display: none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
        </button>
        <h1 class="app-title">üí¨ YUVRAJ CHAT COMMUNITY</h1>
        <div class="header-actions">
          <button class="icon-btn" onclick="showSection('notifications')" title="Activity">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
          </button>
          <button class="icon-btn" onclick="showSection('create')" title="Create">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="main-content">
        <!-- Home Section -->
        <div id="homeSection" class="content-section active">
          <div class="feed-container">
            <div id="feed"></div>
          </div>
        </div>

        <!-- Search Section -->
        <div id="searchSection" class="content-section">
          <div class="search-header">
            <div class="search-bar">
              <span class="search-icon">üîç</span>
              <input type="text" id="searchQuery" placeholder="Search" />
            </div>
          </div>
          <div class="search-content">
            <div class="recent-searches">
              <h3>Recent</h3>
              <div id="recentSearches"></div>
            </div>
            <div id="searchResults" class="search-results"></div>
          </div>
        </div>

        <!-- Reels Section -->
        <div id="reelsSection" class="content-section">
          <div class="reels-header">
            <h2>Reels</h2>
          </div>
          <div class="reels-container">
            <div id="reelsFeed"></div>
          </div>
        </div>

        <!-- Messages Section -->
        <div id="messagesSection" class="content-section">
          <div class="messages-header">
            <div class="messages-title">
              <h2>Chats</h2>
              <button id="refreshMessages" class="icon-btn" onclick="refreshMessages()" title="Refresh Messages">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
              </button>
            </div>
            <div class="chat-search-container">
              <div class="chat-search-box">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" id="chatSearchInput" placeholder="Search or start new chat" autocomplete="off">
              </div>
            </div>
          </div>
          <div id="chatSearchResults" class="chat-search-results hidden"></div>
          <div id="chatsList" class="chats-list"></div>
          <div id="chatArea" class="chat-area hidden">
            <div class="chat-header">
              <button id="backToChats" class="back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
              </button>
              <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                <div class="chat-avatar" style="width: 32px; height: 32px;">
                  <div class="avatar-placeholder">?</div>
                </div>
                <div>
                  <div class="chat-name" style="font-size: 16px; font-weight: 600; color: #ffffff;">Chat</div>
                  <div style="font-size: 12px; color: #8e8e8e;">Active now</div>
                </div>
              </div>
              <div class="chat-controls">
                <button id="chatThemesBtn" class="theme-btn" title="Chat Themes" onclick="showChatThemes()">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m10.5-3.5L7 7m5 5l4.5 4.5M16.5 7.5L12 12m0 0l-4.5 4.5"/>
                  </svg>
                </button>
                <button id="chatLockBtn" class="lock-btn" title="Chat Lock Settings" onclick="setupChatLock()">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <circle cx="12" cy="16" r="1"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                </button>
                <button id="disableChatLockBtn" class="lock-btn" title="Disable Chat Lock" onclick="disableChatLock()">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <line x1="8" y1="7" x2="16" y2="7"/>
                    <line x1="6" y1="4" x2="18" y2="20"/>
                  </svg>
                </button>
                <button id="deleteChatBtn" class="block-btn" title="Chat Options" onclick="openChatOptionsModal()">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                  </svg>
                </button>
                <button id="deleteAllChatsBtn" class="block-btn" title="Delete All Chats" onclick="deleteAllChats()">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18"/>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                    <circle cx="12" cy="12" r="8" />
                    <line x1="8" y1="8" x2="16" y2="16" />
                    <line x1="16" y1="8" x2="8" y2="16" />
                  </svg>
                </button>
                <button id="blockUserBtn" class="block-btn" title="Block User" onclick="blockCurrentChatUser()">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M4.93 4.93l14.14 14.14"/>
                  </svg>
                </button>
              </div>
            </div>
            <div id="messages" class="whatsapp-chat"></div>
            <div id="typingIndicator" class="hidden">User is typing...</div>
            <form id="messageForm" class="message-form">
              <button type="button" id="fileUploadBtn" class="file-upload-btn" title="Upload File" onclick="document.getElementById('fileInput').click()">üìé</button>
              <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*" onchange="sendFileMessage(this)" />
              <div style="position: relative; flex: 1;">
                <input type="text" id="messageInput" placeholder="Message..." autocomplete="off" />
                <div id="userSuggestions" class="user-suggestions" style="display: none;"></div>
              </div>
              <button id="scheduleBtn" class="schedule-btn" title="Schedule Message" onclick="openScheduleModal()">‚è∞</button>
              <button type="submit" class="send-btn">Send</button>
            </form>
          </div>
        </div>

        <!-- Create Section -->
        <div id="createSection" class="content-section">
          <div class="section-header" style="padding: 1rem;">
            <h2 style="margin: 0; color: #fff;">GENZES CHATS</h2>
          </div>
          <div class="create-options">
            <div class="create-grid">
              <button id="createPost" class="create-option" onclick="openCreatePostModal()">
                <div class="create-icon">üì∑</div>
                <span>Post</span>
              </button>
              <button id="createReel" class="create-option" onclick="openCreateReelModal()">
                <div class="create-icon">üé¨</div>
                <span>Reel</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Notifications Section -->
        <div id="notificationsSection" class="content-section">
          <div class="section-header" style="padding: 1rem;">
            <h2 style="margin: 0; color: #fff;">GENZES CHATS</h2>
          </div>
          <div class="notifications-container">
            <div class="notifications-tabs">
              <button class="notification-tab active" data-tab="all">All</button>
              <button class="notification-tab" data-tab="likes">Likes</button>
              <button class="notification-tab" data-tab="follows">Follows</button>
              <button class="notification-tab" data-tab="comments">Comments</button>
            </div>
            <div class="notifications-list" id="notificationsList">
              <!-- Notifications will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="content-section">
          <div class="profile-section">
            <!-- Profile Avatar Section -->
            <div class="profile-avatar-section">
              <div class="profile-avatar-large" id="profileAvatar">
                <span id="profileInitial">U</span>
              </div>
            </div>
            
            <!-- Profile Info Section -->
            <div class="profile-info-section">
              <h2 class="profile-username" id="profileUsername">username</h2>
              <div class="profile-actions">
                <button class="edit-profile-btn" onclick="editProfile()" title="Edit Profile">Edit Profile</button>
                <button id="openSettings" class="settings-btn" title="Settings">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8M12,2A1.31,1.31 0 0,0 10.69,3.31L10.5,4.5C10.5,4.5 10.5,4.5 10.5,4.5C9.97,4.5 9.46,4.67 9.04,5L8.04,4.32C7.64,4 7.1,4 6.69,4.32L5.81,5.19C5.5,5.5 5.5,6 5.81,6.31L6.5,7C6.17,7.42 6,7.93 6,8.46V8.5L4.69,8.69A1.31,1.31 0 0,0 3.31,10.69V13.31A1.31,1.31 0 0,0 4.69,15.31L6,15.5C6,16.03 6.17,16.54 6.5,16.96L5.81,17.69C5.5,18 5.5,18.5 5.81,18.81L6.69,19.69C7,20 7.5,20 7.81,19.69L8.5,19C8.92,19.33 9.43,19.5 9.96,19.5H10L10.31,20.69A1.31,1.31 0 0,0 12,22A1.31,1.31 0 0,0 13.69,20.69L14,19.5C14.53,19.5 15.04,19.33 15.46,19L16.19,19.69C16.5,20 17,20 17.31,19.69L18.19,18.81C18.5,18.5 18.5,18 18.19,17.69L17.5,17C17.83,16.58 18,16.07 18,15.54V15.5L19.31,15.31A1.31,1.31 0 0,0 20.69,13.31V10.69A1.31,1.31 0 0,0 19.31,8.69L18,8.5C18,7.97 17.83,7.46 17.5,7.04L18.19,6.31C18.5,6 18.5,5.5 18.19,5.19L17.31,4.31C17,4 16.5,4 16.19,4.31L15.5,5C15.08,4.67 14.57,4.5 14.04,4.5H14L13.69,3.31A1.31,1.31 0 0,0 12,2Z"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Profile Stats Section -->
            <div class="profile-stats-section">
              <div class="stat" onclick="showPosts()">
                <span class="stat-number" id="postsCount">0</span>
                <span class="stat-label">posts</span>
              </div>
              <div class="stat" onclick="showFollowers()">
                <span class="stat-number" id="followersCount">0</span>
                <span class="stat-label">followers</span>
              </div>
              <div class="stat" onclick="showFollowing()">
                <span class="stat-number" id="followingCount">0</span>
                <span class="stat-label">following</span>
              </div>
            </div>
            
            <!-- Profile Bio Section -->
            <div class="profile-bio-section">
              <div class="profile-fullname" id="profileFullname">Full Name</div>
              <div class="profile-bio-text" id="profileBio">Bio goes here...</div>
              <div class="profile-links" id="profileLinks"></div>
            </div>
          </div>
          
          <!-- Profile Tabs -->
          <div class="profile-tabs">
            <button class="profile-tab active" data-tab="posts">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
              </svg>
            </button>
            <button class="profile-tab" data-tab="reels">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
              </svg>
            </button>
            <button class="profile-tab" data-tab="tagged">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </button>
          </div>
          
          <!-- Profile Content -->
          <div class="profile-content">
            <div id="postsContent" class="profile-tab-content">
              <div class="loading">Loading posts...</div>
            </div>
            <div id="reelsContent" class="profile-tab-content hidden">
              <div class="loading">Loading reels...</div>
            </div>
            <div id="taggedContent" class="profile-tab-content hidden">
              <div class="no-content">No tagged posts yet</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Navigation -->
      <div class="bottom-nav">
        <button class="nav-btn active" data-section="home">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
          </span>
          <span class="nav-label">Home</span>
        </button>
        <button class="nav-btn" data-section="search">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
          </span>
          <span class="nav-label">Search</span>
        </button>
        <button class="nav-btn" data-section="reels">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
            </svg>
          </span>
          <span class="nav-label">Reels</span>
        </button>
        <button class="nav-btn" data-section="messages">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
          </span>
          <span class="nav-label">Messages</span>
        </button>
        <button class="nav-btn" data-section="profile">
          <span class="nav-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </span>
          <span class="nav-label">Profile</span>
        </button>
      </div>
    </div>

    <!-- Modals -->
    <div id="createPostModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog">
        <div class="modal-header">
          <h3>Create Post</h3>
          <button id="closeCreatePost" class="close-btn">√ó</button>
        </div>
        <form id="createPostForm" class="modal-form">
          <label>Media
            <button type="button" id="btnPickMedia" class="upload-btn">Choose Photo/Video</button>
            <input type="file" id="postImage" accept="image/*,video/*" capture="environment" style="display: none;" />
            <div id="mediaSelected" style="margin-top: 8px; font-size: 0.9em; color: #666;"></div>
          </label>
          <div id="postPreview" class="media-preview"></div>
          <label>Caption
            <textarea id="postCaption" rows="3" placeholder="Write a caption..."></textarea>
          </label>
          <label>Audience
            <select id="postAudience">
              <option value="public">Public</option>
              <option value="followers">Followers only</option>
              <option value="close_friends">Close friends</option>
            </select>
          </label>
          <div class="modal-actions">
            <button type="button" id="cancelCreatePost" class="cancel-btn">Cancel</button>
            <button type="submit" class="save-btn">Post</button>
          </div>
        </form>
      </div>
    </div>

    <div id="createReelModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog">
        <div class="modal-header">
          <h3>Create Reel</h3>
          <button id="closeCreateReel" class="close-btn">√ó</button>
        </div>
        <form id="createReelForm" class="modal-form">
          <label>Video
            <button type="button" id="btnPickReelVideo" class="upload-btn">Choose Video</button>
            <input type="file" id="reelVideo" accept="video/*" capture="environment" style="display: none;" />
            <div id="reelVideoSelected" style="margin-top: 8px; font-size: 0.9em; color: #666;"></div>
          </label>
          <div id="reelPreview" class="media-preview"></div>
          <label>Caption
            <textarea id="reelCaption" rows="3" placeholder="Write a caption..."></textarea>
          </label>
          <label>Audience
            <select id="reelAudience">
              <option value="public">Public</option>
              <option value="followers">Followers only</option>
              <option value="close_friends">Close friends</option>
            </select>
          </label>
          <div class="modal-actions">
            <button type="button" id="cancelCreateReel" class="cancel-btn">Cancel</button>
            <button type="submit" class="save-btn">Share Reel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog" style="max-width: 500px; background: #262626; color: #ffffff;">
        <div class="modal-header" style="background: #262626; color: #ffffff; border-bottom: 1px solid #3c3c3c;">
          <h3 style="color: #ffffff; display: flex; align-items: center; gap: 0.5rem;">
            <button onclick="closeEditProfile()" class="back-btn" style="background: none; border: none; color: #ffffff; cursor: pointer; padding: 0.25rem; display: flex; align-items: center; justify-content: center;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m15 18-6-6 6-6"/>
              </svg>
            </button>
            Edit Profile
          </h3>
          <button onclick="closeEditProfile()" class="close-btn" style="color: #ffffff;">√ó</button>
        </div>
        <form id="editProfileForm" class="modal-form" style="background: #262626; padding: 1.5rem;">
          <!-- Profile Picture Upload -->
          <div class="form-group" style="text-align: center; margin-bottom: 1.5rem;">
            <div class="profile-pic-container" style="position: relative; display: inline-block; margin-bottom: 1rem;">
              <div id="currentProfilePic" class="profile-pic" style="width: 120px; height: 120px; border-radius: 50%; background: #3c3c3c; margin: 0 auto; overflow: hidden; position: relative; cursor: pointer; border: 3px solid #555;" onclick="selectProfilePic()">
                <img id="profilePicPreview" style="width: 100%; height: 100%; object-fit: cover; display: none;" />
                <div id="profilePicPlaceholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ffffff; font-size: 3rem;">üì∑</div>
              </div>
              <button type="button" onclick="selectProfilePic()" class="btn btn-primary" style="margin-top: 0.5rem; font-size: 0.9rem; padding: 0.5rem 1rem; background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d); border: none; color: white; border-radius: 6px; cursor: pointer; display: inline-block;">Change Photo</button>
            </div>
            <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
          </div>
          
          <!-- Profile Information -->
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #ffffff;">Username</label>
            <input type="text" id="edit_username" placeholder="Username" required style="width: 100%; padding: 0.75rem; border: 1px solid #555; border-radius: 6px; font-size: 16px; background: #3c3c3c; color: #ffffff;">
          </div>
          
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #ffffff;">Full Name</label>
            <input type="text" id="edit_fullname" placeholder="Full Name" style="width: 100%; padding: 0.75rem; border: 1px solid #555; border-radius: 6px; font-size: 16px; background: #3c3c3c; color: #ffffff;">
          </div>
          
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #ffffff;">Bio</label>
            <textarea id="edit_bio" placeholder="Tell us about yourself..." rows="3" maxlength="150" style="width: 100%; padding: 0.75rem; border: 1px solid #555; border-radius: 6px; font-size: 16px; resize: none; background: #3c3c3c; color: #ffffff;"></textarea>
            <div style="text-align: right; font-size: 0.8rem; color: #aaa; margin-top: 0.25rem;">
              <span id="bioCount">0</span>/150
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #ffffff;">Website/Links</label>
            <textarea id="edit_links" placeholder="Add your website or social links (one per line)" rows="2" style="width: 100%; padding: 0.75rem; border: 1px solid #555; border-radius: 6px; font-size: 16px; resize: none; background: #3c3c3c; color: #ffffff;"></textarea>
          </div>
          
          <!-- Privacy Settings -->
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: #ffffff;">Private Account</div>
                <div style="font-size: 0.8rem; color: #aaa;">Only followers can see your posts</div>
              </div>
              <input type="checkbox" id="edit_private" style="width: auto;">
            </div>
          </div>
          
          <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
            <button type="button" onclick="closeEditProfile()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
            <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem; background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d); color: white; border: none; border-radius: 6px; cursor: pointer;">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <div id="settingsModal" class="modal settings-modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog">
        <div class="settings-header">
          <h3>Settings</h3>
          <button id="closeSettings" class="close-btn">√ó</button>
        </div>
        <div class="settings-body">
          <div class="settings-item" onclick="showEditProfile()">
            <h4>Edit Profile</h4>
            <p>Change your username, bio, and profile picture</p>
          </div>
          <div class="settings-item" onclick="accountPrivacy()">
            <h4>Account Privacy</h4>
            <p>Manage who can see your content</p>
          </div>
          <div class="settings-item" onclick="setupChatLock()">
            <h4>üîí Chat Lock</h4>
            <p>Secure your messages with a password</p>
          </div>
          <div class="settings-item" onclick="viewBlockedAccounts()">
            <h4>üö´ Blocked Accounts</h4>
            <p>Manage blocked users</p>
          </div>
          <div class="settings-item" onclick="notificationSettings()">
            <h4>üîî Notifications</h4>
            <p>Control your notification preferences</p>
          </div>
          <div class="settings-item" onclick="dataDownload()">
            <h4>üì• Download Data</h4>
            <p>Download a copy of your data</p>
          </div>
          <div class="settings-item" onclick="deleteAllChats()">
            <h4>üí• Delete All Chats</h4>
            <p>Permanently delete all your messages</p>
          </div>
          <div class="settings-item" onclick="disableAccount()">
            <h4>üö´ Disable Account</h4>
            <p>Temporarily disable your account</p>
          </div>
          <div class="settings-item" onclick="logout()">
            <h4>üö™ Logout</h4>
            <p>Sign out of your account</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts - Import only once -->
  <script src="js/supabaseClient.js"></script>
  <script src="js/auth-check.js"></script>
  <script src="js/features.js"></script>
  <script src="js/app.js?v=3"></script>
  <script src="js/enhanced-features.js"></script>

  <script>
    // Fixed Load messages function with proper WhatsApp UI structure
    window.loadMessages = async function(partnerId) {
      try {
        const { data: messages, error } = await window.sb
          .from('messages')
          .select('*')
          .or(`sender_id.eq.${window.currentUser?.id}.and.receiver_id.eq.${partnerId},sender_id.eq.${partnerId}.and.receiver_id.eq.${window.currentUser?.id}`)
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        const messagesContainer = document.getElementById('messages');
        messagesContainer.classList.add('whatsapp-chat');
        let html = '';
        
        if (messages?.length) {
          let lastDate = '';
          
          messages.forEach((message, index) => {
            const isMe = message.sender_id === window.currentUser?.id;
            const messageDate = new Date(message.created_at).toDateString();
            const editedText = message.edited ? ' (edited)' : '';
            
            // Add date separator
            if (messageDate !== lastDate) {
              html += `<div class="date-separator">${formatDate(message.created_at)}</div>`;
              lastDate = messageDate;
            }
            
            // Group consecutive messages from same sender
            const prevMessage = messages[index - 1];
            const nextMessage = messages[index + 1];
            const isFirstInGroup = !prevMessage || prevMessage.sender_id !== message.sender_id || messageDate !== new Date(prevMessage.created_at).toDateString();
            const isLastInGroup = !nextMessage || nextMessage.sender_id !== message.sender_id || new Date(nextMessage.created_at).toDateString() !== messageDate;
            
            html += `
              <div class="message-wrapper ${isMe ? 'me' : 'them'}">
                <div class="message ${isFirstInGroup ? 'first' : ''} ${isLastInGroup ? 'last' : ''}" data-message-id="${message.id}">
                  <div class="message-content">
                    ${message.file_url && message.file_url !== 'null' && message.file_url.trim() ? 
                      (message.file_type?.startsWith('image/') ? 
                        `<img src="${message.file_url}" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer; display: block; margin-bottom: 4px;" onclick="showImageModal('${message.file_url}', '${message.file_name}')" />` :
                        `<video src="${message.file_url}" controls style="max-width: 200px; max-height: 200px; border-radius: 8px; display: block; margin-bottom: 4px;" />`
                      ) :
                      `<div class="message-text">${message.content}${editedText}</div>`
                    }
                    ${isLastInGroup ? `
                      <div class="message-time">
                        ${formatTime(message.created_at)}
                        ${isMe ? '<span class="message-status">‚úì‚úì</span>' : ''}
                      </div>
                    ` : ''}
                  </div>
                  ${isMe ? `
                    <div class="message-actions">
                      <button onclick="editMessage('${message.id}', ${JSON.stringify(message.content || '')})" class="message-action-btn" title="Edit">‚úèÔ∏è</button>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          });
        } else {
          html = `
            <div class="empty-messages">
              <div class="empty-icon">üí¨</div>
              <h3>No messages yet</h3>
              <p>Send a message to start the conversation</p>
            </div>
          `;
        }
        
        messagesContainer.innerHTML = html;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
      } catch (error) {
        console.error('Error loading messages:', error);
        const messagesContainer = document.getElementById('messages');
        if (messagesContainer) {
          messagesContainer.innerHTML = `
            <div class="empty-messages">
              <div class="empty-icon">‚ö†Ô∏è</div>
              <p>Error loading messages</p>
            </div>
          `;
        }
      }
    };
    
    // Format date function for message grouping
    window.formatDate = function(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const diffTime = today - messageDate;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return date.toLocaleDateString('en-US', { weekday: 'long' });
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    };
    
    // Format time function
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
      return Math.floor(diff / 86400000) + 'd';
    }

    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ App initialization complete');
    });
  </script>
</body>
</html>